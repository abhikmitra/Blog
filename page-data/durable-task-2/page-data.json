{"componentChunkName":"component---src-templates-blog-post-js","path":"/durable-task-2/","result":{"data":{"site":{"siteMetadata":{"title":"Abhik's Blog"}},"markdownRemark":{"id":"6776fa29-7a4c-5fa0-8bb8-97c3bf2507c5","excerpt":"Durable Task Framework Series This post is part 2 of a series of posts on DTF. Durable Task Framework Internals - Part 1 (Dataflow and Reliability) Durable Task…","html":"<h3>Durable Task Framework Series</h3>\n<p>This post is <strong>part 2</strong> of a series of posts on DTF.</p>\n<ol>\n<li><a href=\"https://abhikmitra.github.io/blog/durable-task/\">Durable Task Framework Internals - Part 1 (Dataflow and Reliability)</a></li>\n<li><a href=\"https://abhikmitra.github.io/blog/durable-task-2/\">Durable Task Framework Internals - Part 2 (The curious case of Orchestrations)</a></li>\n<li><a href=\"https://abhikmitra.github.io/blog/durable-task-3/\">Durable Task Framework Internals - Part 3 (Tracker Queue, Instance History, and JumpStart)</a></li>\n<li><a href=\"https://abhikmitra.github.io/blog/durable-task-4/\">Durable Task Framework Internals - Part 4 (Terminated Orchestrations &#x26; Middlewares)</a></li>\n<li><a href=\"https://abhikmitra.github.io/blog/durable-task-5/\">Durable Task Framework Internals - Part 5 (Interesting usages of TPL in DTF)</a></li>\n<li><a href=\"https://abhikmitra.github.io/blog/durable-task-5/\">Durable Task Framework Internals - Part 6 (Orchestration Execution Flow)</a></li>\n</ol>\n<p>Do you think there is more that I should cover or something I should fix ? Please raise an <a href=\"https://github.com/abhikmitra/blog/issues\">issue</a> and let me know</p>\n<hr>\n<h3>Multi Activity Orchestrations</h3>\n<p>We will see whats the process of  Orchestration in case of multiple activities as that’s what you will frequently have.</p>\n<p>Here is a sequence diagram of the happy path with an orchestration comprising of two activitties <code class=\"language-text\">TaskActivity1</code> and <code class=\"language-text\">TaskActivity2</code></p>\n<div class=\"mermaid\" data-processed=\"true\"><svg id=\"mermaid-1590339706798\" width=\"100%\" xmlns=\"http://www.w3.org/2000/svg\" height=\"100%\" style=\"max-width:1450px;\" viewBox=\"-50 -10 1450 881\"><rect x=\"465\" y=\"695\" fill=\"rgb(255, 255, 0, 0.5)\" width=\"220\" height=\"55\" class=\"rect\"></rect><rect x=\"465\" y=\"525\" fill=\"rgb(255, 255, 0, 0.5)\" width=\"220\" height=\"55\" class=\"rect\"></rect><rect x=\"465\" y=\"145\" fill=\"rgb(255, 255, 0, 0.5)\" width=\"220\" height=\"55\" class=\"rect\"></rect><style>#mermaid-1590339706798 .label{font-family:'trebuchet ms', verdana, arial;font-family:var(--mermaid-font-family);color:#333}#mermaid-1590339706798 .label text{fill:#333}#mermaid-1590339706798 .node rect,#mermaid-1590339706798 .node circle,#mermaid-1590339706798 .node ellipse,#mermaid-1590339706798 .node polygon,#mermaid-1590339706798 .node path{fill:#ECECFF;stroke:#9370db;stroke-width:1px}#mermaid-1590339706798 .node .label{text-align:center}#mermaid-1590339706798 .node.clickable{cursor:pointer}#mermaid-1590339706798 .arrowheadPath{fill:#333}#mermaid-1590339706798 .edgePath .path{stroke:#333;stroke-width:1.5px}#mermaid-1590339706798 .edgeLabel{background-color:#e8e8e8;text-align:center}#mermaid-1590339706798 .cluster rect{fill:#ffffde;stroke:#aa3;stroke-width:1px}#mermaid-1590339706798 .cluster text{fill:#333}#mermaid-1590339706798 div.mermaidTooltip{position:absolute;text-align:center;max-width:200px;padding:2px;font-family:'trebuchet ms', verdana, arial;font-family:var(--mermaid-font-family);font-size:12px;background:#ffffde;border:1px solid #aa3;border-radius:2px;pointer-events:none;z-index:100}#mermaid-1590339706798 .actor{stroke:#ccf;fill:#ECECFF}#mermaid-1590339706798 text.actor{fill:#000;stroke:none}#mermaid-1590339706798 .actor-line{stroke:grey}#mermaid-1590339706798 .messageLine0{stroke-width:1.5;stroke-dasharray:'2 2';stroke:#333}#mermaid-1590339706798 .messageLine1{stroke-width:1.5;stroke-dasharray:'2 2';stroke:#333}#mermaid-1590339706798 #arrowhead{fill:#333}#mermaid-1590339706798 .sequenceNumber{fill:#fff}#mermaid-1590339706798 #sequencenumber{fill:#333}#mermaid-1590339706798 #crosshead path{fill:#333 !important;stroke:#333 !important}#mermaid-1590339706798 .messageText{fill:#333;stroke:none}#mermaid-1590339706798 .labelBox{stroke:#ccf;fill:#ECECFF}#mermaid-1590339706798 .labelText{fill:#000;stroke:none}#mermaid-1590339706798 .loopText{fill:#000;stroke:none}#mermaid-1590339706798 .loopLine{stroke-width:2;stroke-dasharray:'2 2';stroke:#ccf}#mermaid-1590339706798 .note{stroke:#aa3;fill:#fff5ad}#mermaid-1590339706798 .noteText{fill:black;stroke:none;font-family:'trebuchet ms', verdana, arial;font-family:var(--mermaid-font-family);font-size:14px}#mermaid-1590339706798 .activation0{fill:#f4f4f4;stroke:#666}#mermaid-1590339706798 .activation1{fill:#f4f4f4;stroke:#666}#mermaid-1590339706798 .activation2{fill:#f4f4f4;stroke:#666}#mermaid-1590339706798 .mermaid-main-font{font-family:\"trebuchet ms\", verdana, arial;font-family:var(--mermaid-font-family)}#mermaid-1590339706798 .section{stroke:none;opacity:0.2}#mermaid-1590339706798 .section0{fill:rgba(102,102,255,0.49)}#mermaid-1590339706798 .section2{fill:#fff400}#mermaid-1590339706798 .section1,#mermaid-1590339706798 .section3{fill:#fff;opacity:0.2}#mermaid-1590339706798 .sectionTitle0{fill:#333}#mermaid-1590339706798 .sectionTitle1{fill:#333}#mermaid-1590339706798 .sectionTitle2{fill:#333}#mermaid-1590339706798 .sectionTitle3{fill:#333}#mermaid-1590339706798 .sectionTitle{text-anchor:start;font-size:11px;text-height:14px;font-family:'trebuchet ms', verdana, arial;font-family:var(--mermaid-font-family)}#mermaid-1590339706798 .grid .tick{stroke:#d3d3d3;opacity:0.8;shape-rendering:crispEdges}#mermaid-1590339706798 .grid .tick text{font-family:'trebuchet ms', verdana, arial;font-family:var(--mermaid-font-family)}#mermaid-1590339706798 .grid path{stroke-width:0}#mermaid-1590339706798 .today{fill:none;stroke:red;stroke-width:2px}#mermaid-1590339706798 .task{stroke-width:2}#mermaid-1590339706798 .taskText{text-anchor:middle;font-family:'trebuchet ms', verdana, arial;font-family:var(--mermaid-font-family)}#mermaid-1590339706798 .taskText:not([font-size]){font-size:11px}#mermaid-1590339706798 .taskTextOutsideRight{fill:#000;text-anchor:start;font-size:11px;font-family:'trebuchet ms', verdana, arial;font-family:var(--mermaid-font-family)}#mermaid-1590339706798 .taskTextOutsideLeft{fill:#000;text-anchor:end;font-size:11px}#mermaid-1590339706798 .task.clickable{cursor:pointer}#mermaid-1590339706798 .taskText.clickable{cursor:pointer;fill:#003163 !important;font-weight:bold}#mermaid-1590339706798 .taskTextOutsideLeft.clickable{cursor:pointer;fill:#003163 !important;font-weight:bold}#mermaid-1590339706798 .taskTextOutsideRight.clickable{cursor:pointer;fill:#003163 !important;font-weight:bold}#mermaid-1590339706798 .taskText0,#mermaid-1590339706798 .taskText1,#mermaid-1590339706798 .taskText2,#mermaid-1590339706798 .taskText3{fill:#fff}#mermaid-1590339706798 .task0,#mermaid-1590339706798 .task1,#mermaid-1590339706798 .task2,#mermaid-1590339706798 .task3{fill:#8a90dd;stroke:#534fbc}#mermaid-1590339706798 .taskTextOutside0,#mermaid-1590339706798 .taskTextOutside2{fill:#000}#mermaid-1590339706798 .taskTextOutside1,#mermaid-1590339706798 .taskTextOutside3{fill:#000}#mermaid-1590339706798 .active0,#mermaid-1590339706798 .active1,#mermaid-1590339706798 .active2,#mermaid-1590339706798 .active3{fill:#bfc7ff;stroke:#534fbc}#mermaid-1590339706798 .activeText0,#mermaid-1590339706798 .activeText1,#mermaid-1590339706798 .activeText2,#mermaid-1590339706798 .activeText3{fill:#000 !important}#mermaid-1590339706798 .done0,#mermaid-1590339706798 .done1,#mermaid-1590339706798 .done2,#mermaid-1590339706798 .done3{stroke:grey;fill:#d3d3d3;stroke-width:2}#mermaid-1590339706798 .doneText0,#mermaid-1590339706798 .doneText1,#mermaid-1590339706798 .doneText2,#mermaid-1590339706798 .doneText3{fill:#000 !important}#mermaid-1590339706798 .crit0,#mermaid-1590339706798 .crit1,#mermaid-1590339706798 .crit2,#mermaid-1590339706798 .crit3{stroke:#f88;fill:red;stroke-width:2}#mermaid-1590339706798 .activeCrit0,#mermaid-1590339706798 .activeCrit1,#mermaid-1590339706798 .activeCrit2,#mermaid-1590339706798 .activeCrit3{stroke:#f88;fill:#bfc7ff;stroke-width:2}#mermaid-1590339706798 .doneCrit0,#mermaid-1590339706798 .doneCrit1,#mermaid-1590339706798 .doneCrit2,#mermaid-1590339706798 .doneCrit3{stroke:#f88;fill:#d3d3d3;stroke-width:2;cursor:pointer;shape-rendering:crispEdges}#mermaid-1590339706798 .milestone{transform:rotate(45deg) scale(0.8, 0.8)}#mermaid-1590339706798 .milestoneText{font-style:italic}#mermaid-1590339706798 .doneCritText0,#mermaid-1590339706798 .doneCritText1,#mermaid-1590339706798 .doneCritText2,#mermaid-1590339706798 .doneCritText3{fill:#000 !important}#mermaid-1590339706798 .activeCritText0,#mermaid-1590339706798 .activeCritText1,#mermaid-1590339706798 .activeCritText2,#mermaid-1590339706798 .activeCritText3{fill:#000 !important}#mermaid-1590339706798 .titleText{text-anchor:middle;font-size:18px;fill:#000;font-family:'trebuchet ms', verdana, arial;font-family:var(--mermaid-font-family)}#mermaid-1590339706798 g.classGroup text{fill:#9370db;stroke:none;font-family:'trebuchet ms', verdana, arial;font-family:var(--mermaid-font-family);font-size:10px}#mermaid-1590339706798 g.classGroup text .title{font-weight:bolder}#mermaid-1590339706798 g.clickable{cursor:pointer}#mermaid-1590339706798 g.classGroup rect{fill:#ECECFF;stroke:#9370db}#mermaid-1590339706798 g.classGroup line{stroke:#9370db;stroke-width:1}#mermaid-1590339706798 .classLabel .box{stroke:none;stroke-width:0;fill:#ECECFF;opacity:0.5}#mermaid-1590339706798 .classLabel .label{fill:#9370db;font-size:10px}#mermaid-1590339706798 .relation{stroke:#9370db;stroke-width:1;fill:none}#mermaid-1590339706798 .dashed-line{stroke-dasharray:3}#mermaid-1590339706798 #compositionStart{fill:#9370db;stroke:#9370db;stroke-width:1}#mermaid-1590339706798 #compositionEnd{fill:#9370db;stroke:#9370db;stroke-width:1}#mermaid-1590339706798 #aggregationStart{fill:#ECECFF;stroke:#9370db;stroke-width:1}#mermaid-1590339706798 #aggregationEnd{fill:#ECECFF;stroke:#9370db;stroke-width:1}#mermaid-1590339706798 #dependencyStart{fill:#9370db;stroke:#9370db;stroke-width:1}#mermaid-1590339706798 #dependencyEnd{fill:#9370db;stroke:#9370db;stroke-width:1}#mermaid-1590339706798 #extensionStart{fill:#9370db;stroke:#9370db;stroke-width:1}#mermaid-1590339706798 #extensionEnd{fill:#9370db;stroke:#9370db;stroke-width:1}#mermaid-1590339706798 .commit-id,#mermaid-1590339706798 .commit-msg,#mermaid-1590339706798 .branch-label{fill:lightgrey;color:lightgrey;font-family:'trebuchet ms', verdana, arial;font-family:var(--mermaid-font-family)}#mermaid-1590339706798 .pieTitleText{text-anchor:middle;font-size:25px;fill:#000;font-family:'trebuchet ms', verdana, arial;font-family:var(--mermaid-font-family)}#mermaid-1590339706798 .slice{font-family:'trebuchet ms', verdana, arial;font-family:var(--mermaid-font-family)}#mermaid-1590339706798 g.stateGroup text{fill:#9370db;stroke:none;font-size:10px;font-family:'trebuchet ms', verdana, arial;font-family:var(--mermaid-font-family)}#mermaid-1590339706798 g.stateGroup text{fill:#9370db;stroke:none;font-size:10px}#mermaid-1590339706798 g.stateGroup .state-title{font-weight:bolder;fill:#000}#mermaid-1590339706798 g.stateGroup rect{fill:#ECECFF;stroke:#9370db}#mermaid-1590339706798 g.stateGroup line{stroke:#9370db;stroke-width:1}#mermaid-1590339706798 .transition{stroke:#9370db;stroke-width:1;fill:none}#mermaid-1590339706798 .stateGroup .composit{fill:white;border-bottom:1px}#mermaid-1590339706798 .stateGroup .alt-composit{fill:#e0e0e0;border-bottom:1px}#mermaid-1590339706798 .state-note{stroke:#aa3;fill:#fff5ad}#mermaid-1590339706798 .state-note text{fill:black;stroke:none;font-size:10px}#mermaid-1590339706798 .stateLabel .box{stroke:none;stroke-width:0;fill:#ECECFF;opacity:0.5}#mermaid-1590339706798 .stateLabel text{fill:#000;font-size:10px;font-weight:bold;font-family:'trebuchet ms', verdana, arial;font-family:var(--mermaid-font-family)}:root{--mermaid-font-family: '\"trebuchet ms\", verdana, arial';--mermaid-font-family: \"Comic Sans MS\", \"Comic Sans\", cursive}\n\n:root { --mermaid-font-family: \"trebuchet ms\", verdana, arial;}</style><style>#mermaid-1590339706798 {\n    color: rgb(0, 0, 0);\n    font: normal normal 400 normal 16px / normal \"trebuchet ms\", verdana, arial;\n  }</style><g></g><g><line id=\"actor0\" x1=\"75\" y1=\"5\" x2=\"75\" y2=\"870\" class=\"actor-line\" stroke-width=\"0.5px\" stroke=\"#999\"></line><rect x=\"0\" y=\"0\" fill=\"#eaeaea\" stroke=\"#666\" width=\"150\" height=\"65\" rx=\"3\" ry=\"3\" class=\"actor\"></rect><text x=\"75\" y=\"32.5\" dominant-baseline=\"central\" alignment-baseline=\"central\" class=\"actor\" style=\"text-anchor: middle; font-size: 14px;\"><tspan x=\"75\" dy=\"0\">Client</tspan></text></g><g><line id=\"actor1\" x1=\"275\" y1=\"5\" x2=\"275\" y2=\"870\" class=\"actor-line\" stroke-width=\"0.5px\" stroke=\"#999\"></line><rect x=\"200\" y=\"0\" fill=\"#eaeaea\" stroke=\"#666\" width=\"150\" height=\"65\" rx=\"3\" ry=\"3\" class=\"actor\"></rect><text x=\"275\" y=\"32.5\" dominant-baseline=\"central\" alignment-baseline=\"central\" class=\"actor\" style=\"text-anchor: middle; font-size: 14px;\"><tspan x=\"275\" dy=\"0\">Orchestrator</tspan></text></g><g><line id=\"actor2\" x1=\"475\" y1=\"5\" x2=\"475\" y2=\"870\" class=\"actor-line\" stroke-width=\"0.5px\" stroke=\"#999\"></line><rect x=\"400\" y=\"0\" fill=\"#eaeaea\" stroke=\"#666\" width=\"150\" height=\"65\" rx=\"3\" ry=\"3\" class=\"actor\"></rect><text x=\"475\" y=\"32.5\" dominant-baseline=\"central\" alignment-baseline=\"central\" class=\"actor\" style=\"text-anchor: middle; font-size: 14px;\"><tspan x=\"475\" dy=\"0\">Hub</tspan></text></g><g><line id=\"actor3\" x1=\"675\" y1=\"5\" x2=\"675\" y2=\"870\" class=\"actor-line\" stroke-width=\"0.5px\" stroke=\"#999\"></line><rect x=\"600\" y=\"0\" fill=\"#eaeaea\" stroke=\"#666\" width=\"150\" height=\"65\" rx=\"3\" ry=\"3\" class=\"actor\"></rect><text x=\"675\" y=\"32.5\" dominant-baseline=\"central\" alignment-baseline=\"central\" class=\"actor\" style=\"text-anchor: middle; font-size: 14px;\"><tspan x=\"675\" dy=\"0\">TestOrchestration</tspan></text></g><g><line id=\"actor4\" x1=\"875\" y1=\"5\" x2=\"875\" y2=\"870\" class=\"actor-line\" stroke-width=\"0.5px\" stroke=\"#999\"></line><rect x=\"800\" y=\"0\" fill=\"#eaeaea\" stroke=\"#666\" width=\"150\" height=\"65\" rx=\"3\" ry=\"3\" class=\"actor\"></rect><text x=\"875\" y=\"32.5\" dominant-baseline=\"central\" alignment-baseline=\"central\" class=\"actor\" style=\"text-anchor: middle; font-size: 14px;\"><tspan x=\"875\" dy=\"0\">Worker</tspan></text></g><g><line id=\"actor5\" x1=\"1075\" y1=\"5\" x2=\"1075\" y2=\"870\" class=\"actor-line\" stroke-width=\"0.5px\" stroke=\"#999\"></line><rect x=\"1000\" y=\"0\" fill=\"#eaeaea\" stroke=\"#666\" width=\"150\" height=\"65\" rx=\"3\" ry=\"3\" class=\"actor\"></rect><text x=\"1075\" y=\"32.5\" dominant-baseline=\"central\" alignment-baseline=\"central\" class=\"actor\" style=\"text-anchor: middle; font-size: 14px;\"><tspan x=\"1075\" dy=\"0\">TaskActivity1</tspan></text></g><g><line id=\"actor6\" x1=\"1275\" y1=\"5\" x2=\"1275\" y2=\"870\" class=\"actor-line\" stroke-width=\"0.5px\" stroke=\"#999\"></line><rect x=\"1200\" y=\"0\" fill=\"#eaeaea\" stroke=\"#666\" width=\"150\" height=\"65\" rx=\"3\" ry=\"3\" class=\"actor\"></rect><text x=\"1275\" y=\"32.5\" dominant-baseline=\"central\" alignment-baseline=\"central\" class=\"actor\" style=\"text-anchor: middle; font-size: 14px;\"><tspan x=\"1275\" dy=\"0\">TaskActivity2</tspan></text></g><defs><marker id=\"arrowhead\" refX=\"5\" refY=\"2\" markerWidth=\"6\" markerHeight=\"4\" orient=\"auto\"><path d=\"M 0,0 V 4 L6,2 Z\"></path></marker></defs><defs><marker id=\"crosshead\" markerWidth=\"15\" markerHeight=\"8\" orient=\"auto\" refX=\"16\" refY=\"4\"><path fill=\"black\" stroke=\"#000000\" stroke-width=\"1px\" d=\"M 9,2 V 6 L16,4 Z\" style=\"stroke-dasharray: 0, 0;\"></path><path fill=\"none\" stroke=\"#000000\" stroke-width=\"1px\" d=\"M 0,1 L 6,7 M 6,1 L 0,7\" style=\"stroke-dasharray: 0, 0;\"></path></marker></defs><defs><marker id=\"sequencenumber\" refX=\"15\" refY=\"15\" markerWidth=\"60\" markerHeight=\"40\" orient=\"auto\"><circle cx=\"15\" cy=\"15\" r=\"6\"></circle></marker></defs><g><text x=\"175\" y=\"93\" class=\"messageText\" style=\"text-anchor: middle;\">ExecutionStarted</text><line x1=\"75\" y1=\"100\" x2=\"275\" y2=\"100\" class=\"messageLine1\" stroke-width=\"2\" stroke=\"black\" marker-end=\"url(#arrowhead)\" style=\"stroke-dasharray: 3, 3; fill: none;\"></line></g><g><text x=\"375\" y=\"128\" class=\"messageText\" style=\"text-anchor: middle;\">ExecutionStarted</text><line x1=\"275\" y1=\"135\" x2=\"475\" y2=\"135\" class=\"messageLine1\" stroke-width=\"2\" stroke=\"black\" marker-end=\"url(#arrowhead)\" style=\"stroke-dasharray: 3, 3; fill: none;\"></line></g><g><text x=\"575\" y=\"183\" class=\"messageText\" style=\"text-anchor: middle;\">1. Orchestration Invoked</text><line x1=\"475\" y1=\"190\" x2=\"675\" y2=\"190\" class=\"messageLine0\" stroke-width=\"2\" stroke=\"black\" marker-end=\"url(#arrowhead)\" style=\"fill: none;\"></line></g><g><text x=\"675\" y=\"228\" class=\"messageText\" style=\"text-anchor: middle;\">TaskScheduled</text><line x1=\"475\" y1=\"235\" x2=\"875\" y2=\"235\" class=\"messageLine1\" stroke-width=\"2\" stroke=\"black\" marker-end=\"url(#arrowhead)\" style=\"stroke-dasharray: 3, 3; fill: none;\"></line></g><g><text x=\"675\" y=\"263\" class=\"messageText\" style=\"text-anchor: middle;\">TaskScheduled</text><line x1=\"475\" y1=\"270\" x2=\"875\" y2=\"270\" class=\"messageLine1\" stroke-width=\"2\" stroke=\"black\" marker-end=\"url(#arrowhead)\" style=\"stroke-dasharray: 3, 3; fill: none;\"></line></g><g><text x=\"675\" y=\"298\" class=\"messageText\" style=\"text-anchor: middle;\">Task Scheduled</text><line x1=\"875\" y1=\"305\" x2=\"475\" y2=\"305\" class=\"messageLine1\" stroke-width=\"2\" stroke=\"black\" marker-end=\"url(#arrowhead)\" style=\"stroke-dasharray: 3, 3; fill: none;\"></line></g><g><text x=\"775\" y=\"333\" class=\"messageText\" style=\"text-anchor: middle;\">Task Invoked</text><line x1=\"475\" y1=\"340\" x2=\"1075\" y2=\"340\" class=\"messageLine0\" stroke-width=\"2\" stroke=\"black\" marker-end=\"url(#arrowhead)\" style=\"fill: none;\"></line></g><g><rect x=\"1070\" y=\"342\" fill=\"#EDF2AE\" stroke=\"#666\" width=\"10\" height=\"273\" rx=\"0\" ry=\"0\" class=\"activation0\"></rect></g><g><text x=\"675\" y=\"368\" class=\"messageText\" style=\"text-anchor: middle;\">Task Scheduled</text><line x1=\"875\" y1=\"375\" x2=\"475\" y2=\"375\" class=\"messageLine1\" stroke-width=\"2\" stroke=\"black\" marker-end=\"url(#arrowhead)\" style=\"stroke-dasharray: 3, 3; fill: none;\"></line></g><g><text x=\"875\" y=\"403\" class=\"messageText\" style=\"text-anchor: middle;\">Task Invoked</text><line x1=\"475\" y1=\"410\" x2=\"1275\" y2=\"410\" class=\"messageLine0\" stroke-width=\"2\" stroke=\"black\" marker-end=\"url(#arrowhead)\" style=\"fill: none;\"></line></g><g><rect x=\"1270\" y=\"412\" fill=\"#EDF2AE\" stroke=\"#666\" width=\"10\" height=\"33\" rx=\"0\" ry=\"0\" class=\"activation0\"></rect></g><g><text x=\"872.5\" y=\"438\" class=\"messageText\" style=\"text-anchor: middle;\">Task Finished</text><line x1=\"1270\" y1=\"445\" x2=\"475\" y2=\"445\" class=\"messageLine0\" stroke-width=\"2\" stroke=\"black\" marker-end=\"url(#arrowhead)\" style=\"fill: none;\"></line></g><g><text x=\"375\" y=\"473\" class=\"messageText\" style=\"text-anchor: middle;\">TaskCompleted</text><line x1=\"475\" y1=\"480\" x2=\"275\" y2=\"480\" class=\"messageLine1\" stroke-width=\"2\" stroke=\"black\" marker-end=\"url(#arrowhead)\" style=\"stroke-dasharray: 3, 3; fill: none;\"></line></g><g><text x=\"375\" y=\"508\" class=\"messageText\" style=\"text-anchor: middle;\">TaskCompleted</text><line x1=\"275\" y1=\"515\" x2=\"475\" y2=\"515\" class=\"messageLine1\" stroke-width=\"2\" stroke=\"black\" marker-end=\"url(#arrowhead)\" style=\"stroke-dasharray: 3, 3; fill: none;\"></line></g><g><text x=\"575\" y=\"563\" class=\"messageText\" style=\"text-anchor: middle;\">2. Orchestration Invoked</text><line x1=\"475\" y1=\"570\" x2=\"675\" y2=\"570\" class=\"messageLine0\" stroke-width=\"2\" stroke=\"black\" marker-end=\"url(#arrowhead)\" style=\"fill: none;\"></line></g><g><text x=\"772.5\" y=\"608\" class=\"messageText\" style=\"text-anchor: middle;\">Task Finished</text><line x1=\"1070\" y1=\"615\" x2=\"475\" y2=\"615\" class=\"messageLine0\" stroke-width=\"2\" stroke=\"black\" marker-end=\"url(#arrowhead)\" style=\"fill: none;\"></line></g><g><text x=\"375\" y=\"643\" class=\"messageText\" style=\"text-anchor: middle;\">TaskCompleted</text><line x1=\"475\" y1=\"650\" x2=\"275\" y2=\"650\" class=\"messageLine1\" stroke-width=\"2\" stroke=\"black\" marker-end=\"url(#arrowhead)\" style=\"stroke-dasharray: 3, 3; fill: none;\"></line></g><g><text x=\"375\" y=\"678\" class=\"messageText\" style=\"text-anchor: middle;\">TaskCompleted</text><line x1=\"275\" y1=\"685\" x2=\"475\" y2=\"685\" class=\"messageLine1\" stroke-width=\"2\" stroke=\"black\" marker-end=\"url(#arrowhead)\" style=\"stroke-dasharray: 3, 3; fill: none;\"></line></g><g><text x=\"575\" y=\"733\" class=\"messageText\" style=\"text-anchor: middle;\">3. Orchestration Invoked</text><line x1=\"475\" y1=\"740\" x2=\"675\" y2=\"740\" class=\"messageLine0\" stroke-width=\"2\" stroke=\"black\" marker-end=\"url(#arrowhead)\" style=\"fill: none;\"></line></g><g><text x=\"575\" y=\"778\" class=\"messageText\" style=\"text-anchor: middle;\">Orchestration Finished</text><line x1=\"675\" y1=\"785\" x2=\"475\" y2=\"785\" class=\"messageLine0\" stroke-width=\"2\" stroke=\"black\" marker-end=\"url(#arrowhead)\" style=\"fill: none;\"></line></g><g><rect x=\"0\" y=\"805\" fill=\"#eaeaea\" stroke=\"#666\" width=\"150\" height=\"65\" rx=\"3\" ry=\"3\" class=\"actor\"></rect><text x=\"75\" y=\"837.5\" dominant-baseline=\"central\" alignment-baseline=\"central\" class=\"actor\" style=\"text-anchor: middle; font-size: 14px;\"><tspan x=\"75\" dy=\"0\">Client</tspan></text></g><g><rect x=\"200\" y=\"805\" fill=\"#eaeaea\" stroke=\"#666\" width=\"150\" height=\"65\" rx=\"3\" ry=\"3\" class=\"actor\"></rect><text x=\"275\" y=\"837.5\" dominant-baseline=\"central\" alignment-baseline=\"central\" class=\"actor\" style=\"text-anchor: middle; font-size: 14px;\"><tspan x=\"275\" dy=\"0\">Orchestrator</tspan></text></g><g><rect x=\"400\" y=\"805\" fill=\"#eaeaea\" stroke=\"#666\" width=\"150\" height=\"65\" rx=\"3\" ry=\"3\" class=\"actor\"></rect><text x=\"475\" y=\"837.5\" dominant-baseline=\"central\" alignment-baseline=\"central\" class=\"actor\" style=\"text-anchor: middle; font-size: 14px;\"><tspan x=\"475\" dy=\"0\">Hub</tspan></text></g><g><rect x=\"600\" y=\"805\" fill=\"#eaeaea\" stroke=\"#666\" width=\"150\" height=\"65\" rx=\"3\" ry=\"3\" class=\"actor\"></rect><text x=\"675\" y=\"837.5\" dominant-baseline=\"central\" alignment-baseline=\"central\" class=\"actor\" style=\"text-anchor: middle; font-size: 14px;\"><tspan x=\"675\" dy=\"0\">TestOrchestration</tspan></text></g><g><rect x=\"800\" y=\"805\" fill=\"#eaeaea\" stroke=\"#666\" width=\"150\" height=\"65\" rx=\"3\" ry=\"3\" class=\"actor\"></rect><text x=\"875\" y=\"837.5\" dominant-baseline=\"central\" alignment-baseline=\"central\" class=\"actor\" style=\"text-anchor: middle; font-size: 14px;\"><tspan x=\"875\" dy=\"0\">Worker</tspan></text></g><g><rect x=\"1000\" y=\"805\" fill=\"#eaeaea\" stroke=\"#666\" width=\"150\" height=\"65\" rx=\"3\" ry=\"3\" class=\"actor\"></rect><text x=\"1075\" y=\"837.5\" dominant-baseline=\"central\" alignment-baseline=\"central\" class=\"actor\" style=\"text-anchor: middle; font-size: 14px;\"><tspan x=\"1075\" dy=\"0\">TaskActivity1</tspan></text></g><g><rect x=\"1200\" y=\"805\" fill=\"#eaeaea\" stroke=\"#666\" width=\"150\" height=\"65\" rx=\"3\" ry=\"3\" class=\"actor\"></rect><text x=\"1275\" y=\"837.5\" dominant-baseline=\"central\" alignment-baseline=\"central\" class=\"actor\" style=\"text-anchor: middle; font-size: 14px;\"><tspan x=\"1275\" dy=\"0\">TaskActivity2</tspan></text></g></svg></div>\n<h3>The curious case of Orchestrations</h3>\n<p>So we have  the same Orchestration getting invoked 3 times. Curiously only once the orchestration finishes while others dont seem to do anything.\nLets look at the orchestration code.</p>\n<div class=\"gatsby-highlight\" data-language=\"csharp\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-csharp line-numbers\"><code class=\"language-csharp\">Console<span class=\"token punctuation\">.</span><span class=\"token function\">Writeline</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Orchestration Started\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">var</span> task1 <span class=\"token operator\">=</span> context<span class=\"token punctuation\">.</span><span class=\"token generic-method\"><span class=\"token function\">ScheduleWithRetry</span><span class=\"token punctuation\">&lt;</span><span class=\"token keyword\">bool</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">(</span><span class=\"token keyword\">typeof</span><span class=\"token punctuation\">(</span>TestActivity1<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> options<span class=\"token punctuation\">,</span> <span class=\"token string\">\"Test Input1\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">var</span> task2 <span class=\"token operator\">=</span> context<span class=\"token punctuation\">.</span><span class=\"token generic-method\"><span class=\"token function\">ScheduleWithRetry</span><span class=\"token punctuation\">&lt;</span><span class=\"token keyword\">bool</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">(</span><span class=\"token keyword\">typeof</span><span class=\"token punctuation\">(</span>TestActivity2<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> options<span class=\"token punctuation\">,</span> <span class=\"token string\">\"Test Input2\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">var</span> result1 <span class=\"token operator\">=</span>  <span class=\"token keyword\">await</span> task1<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">var</span> result2 <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> task2<span class=\"token punctuation\">;</span>\nConsole<span class=\"token punctuation\">.</span><span class=\"token function\">Writeline</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Orchestration Finished\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">return</span> result<span class=\"token punctuation\">;</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<ul>\n<li>\n<p><strong>First</strong> time Orchestration starts - Replay False - Starts due to TaskCompleted event from the client</p>\n<ul>\n<li>Console logs - Orchestration Started</li>\n<li>Encounters 2 ScheduleWithRetry and sends two taskScheduled event to the Worker</li>\n<li>Goes to the await statement, see that task 1 is not complete. Exits.</li>\n</ul>\n</li>\n<li>\n<p><strong>Second</strong> time orchestration starts - Replay true - Starts due to TaskCompleted event from Task 2 getting completed</p>\n<ul>\n<li>Console logs - Orchestration Started</li>\n<li>Encounters 2 ScheduleWithRetry, which does a noop as the tasks are already scheduled.</li>\n<li>Goes to the await statement, see that task 1 is not complete. Exits.</li>\n</ul>\n</li>\n<li>\n<p><strong>Third time</strong> orchestration starts - Replay true - Starts due to TaskCompleted event from Task 1 getting completed</p>\n<ul>\n<li>Console logs - Orchestration Started</li>\n<li>Encounters 2 ScheduleWithRetry, which does a noop as the tasks are already scheduled.</li>\n<li>Goes to the await statement, sees that task 1 complete, returns the result.</li>\n<li>Goes to the await statement, sees that task 2 is already complete, returns the result.</li>\n<li>Console logs - Orchestration Finished</li>\n</ul>\n</li>\n</ul>\n<p>So, in general, for any orchestration, we will have n number of unfinished Orchestrations and one complete orchestration.</p>\n<h3>Incomplete Orchestrations</h3>\n<p>The orchestrations seem to magically disappear after they encounter <code class=\"language-text\">await</code>, i.e. if Task1 is in flight.</p>\n<div class=\"gatsby-highlight\" data-language=\"csharp\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-csharp line-numbers\"><code class=\"language-csharp\">   <span class=\"token keyword\">var</span> result1 <span class=\"token operator\">=</span>  <span class=\"token keyword\">await</span> task1<span class=\"token punctuation\">;</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span></span></pre></div>\n<ul>\n<li>In Case #1 and case #2 , this <code class=\"language-text\">await</code> never returns because internally when you Schedule a task it cannot invoke the actual task due to the sync nature of execution.</li>\n<li>Instead the framework returns a <a href=\"https://docs.microsoft.com/en-us/dotnet/api/system.threading.tasks.taskcompletionsource-1?view=netframework-4.8\">TaskCompletionSource</a>.</li>\n<li>The framework checks the Service Bus message (TaskCompleted event) which triggered the execution whether it has the result of the await call and resolves the <code class=\"language-text\">TaskCompletionSource</code></li>\n<li>In all other cases <code class=\"language-text\">TaskCompletionSource</code> is never resolved, and hence you get the <code class=\"language-text\">Orchestration Finished</code> log only once and not in the other 2 cases.</li>\n<li>Unfulfilled tasks does not mean that the thread is blocked. The task parallel library will free up the thread and recycle it back to the pool.</li>\n</ul>\n<blockquote>\n<p>The await that you do over the <code class=\"language-text\">ScheduleWithRetry</code> Tasks are syntactic sugar over what is primarily an asynchronous event-driven architecture based on Queues.</p>\n</blockquote>\n<h2>Where do results from taskActivity get stored ?</h2>\n<p>In Part 1, you would have seen that even though hub was shut down , if the Task  execution was complete it will not re-run the Task. Its a similar situation when task1 completes in the multi activity scenario above , orchestration gets executed multiple times and gets the value of Task2 without even executing it more than once. Surely there is some store where the result from the task activities are stored?</p>\n<ul>\n<li>DTF serializes all the events into something called as Session State which is closely tied to the concept of <a href=\"https://docs.microsoft.com/en-us/azure/service-bus-messaging/message-sessions\">Message Sessions</a></li>\n<li>Service bus uses session Id to enforce ordering and partitioning of messages.</li>\n<li>Each session Id allows you to store a 1 Mb/256 Kb blob of data that is called Session State.</li>\n<li>Session is opened when you have a message in the service bus , and a session is closed when all messages of a particular sessionId is cleared and sessionState is set to null.</li>\n<li>DTF uses this session State to store data of all the states that the orchestration went through.</li>\n<li>Once the Orchestration is complete this session state is cleared and message session is closed.</li>\n<li>So the moment a Task completes, DTF puts the result into the event and into the Session State.</li>\n<li>So whenever an Orchestration runs , its able to rebuild the current state by using the session state.</li>\n<li>Here is an example of a session state <span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 562px;\"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/blog/static/2798b67dcb285c283fb0a0df1e938e67/6e88f/serializedState.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 90.54054054054053%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAASCAYAAABb0P4QAAAACXBIWXMAAA7DAAAOwwHHb6hkAAAC2UlEQVQ4y41U2XLaQBDk/38pfsAgdF+AjQAJCYG5BOZK7HKVXe5MjwA7lYdEVVO7O9rt6Znp3cb++RnbaovtdoePjw98fn7i+nH9L3t/f8f5fMbb2xteX1/R2Gw2KPICHPmjnE4xeBxgmCSoqgq73e6/7FmIcWzkeY4szbATx+FwwHq9xmKxwHK5FNbbvw4ySLWplADn3HM1BZxkGcIgRDJIdOzGXYyGQ/R7PZ3TojBCr1vPk8EA02KKoiiQpukNlERIqJGJ0zQ68DwfVseE53qwTAuBF4j58BxPAfnPsV0kyRCJlGQ8HmM0GgnQBi8vL5Ly7gvQ6lhwHRdxFAmzPjoSwBcw13YExBHAUP57F1AHpoyt+5YEtrXeo+EIT08LHI9HNFKJ5FgObMtW0JqNpT6y5Uh/GASwzXoPMyCoI3PDMDT44DGpAcdCmw7LNNFsNuuDtq2pEtgXUJbDNARAgpKl0Wqj3TIQRTHWq7VK7lZDMrQZUYwM2BjzkrLnupoi2ROU7DzPQ5ZNMJ/NJc0nGWcoyxIzWStgPplcUgq1EawjmxHJ2vd99XsCGviBNCLFRPbPBISMKK2FgC6kfgRXQJWNH2q9yKrX7Um6dYA4jgUo1LRjSY+1Y93YAN6ujXR4tVqpEfwGyI1sBpn6kpLv1szoIzMGISh9/W5fdcrL8PDwoOC/fv0UUW+/aqi68+tmhCIR1iwKYwFxNQilZF406ooWW817PdNuG1LPTK8sBf4HQ/OiMWqOHVX5SOf5jyW4Nodsr9lMpyVO55MC8bYoYDHJVaTcUOvRugndkjlFzvW9sLr7cSeAfb3HtLUY7y/1dwNM07Hqy+YNEEaUxRWQnU6ls6UwYWlYt1wI5JdOM11293Q6faXM7sznc3Vsqssr8u014bO03+91M0f6CULjnB3mY1GWM2XZ4FPFJ+xwOGqk78ZUvtt+f8BS9rPLqbDjWQLzBSrkHWWA38xfAK69acTIAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Serialized state\"\n        title=\"Serialized state\"\n        src=\"/blog/static/2798b67dcb285c283fb0a0df1e938e67/6e88f/serializedState.png\"\n        srcset=\"/blog/static/2798b67dcb285c283fb0a0df1e938e67/12f09/serializedState.png 148w,\n/blog/static/2798b67dcb285c283fb0a0df1e938e67/e4a3f/serializedState.png 295w,\n/blog/static/2798b67dcb285c283fb0a0df1e938e67/6e88f/serializedState.png 562w\"\n        sizes=\"(max-width: 562px) 100vw, 562px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></li>\n</ul>","frontmatter":{"title":"Durable Task Framework Internals - Part 2 (The curious case of Orchestrations)","date":"April 24, 2020","description":"A look into how are Orchestrations handled by the framework. A good knowledge of orchestrations is essential in figuring out what can and cannot go in orchestrations"}}},"pageContext":{"slug":"/durable-task-2/","previous":{"fields":{"slug":"/durable-task/"},"frontmatter":{"title":"Durable Task Framework Internals - Part 1 (Dataflow and Reliability)"}},"next":{"fields":{"slug":"/durable-task-3/"},"frontmatter":{"title":"Durable Task Framework Internals - Part 3 (Tracker Queue, Instance History, and JumpStart)"}}}}}