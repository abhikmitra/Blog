{"componentChunkName":"component---src-templates-blog-post-js","path":"/event-hub-3/","result":{"data":{"site":{"siteMetadata":{"title":"Abhik's Blog"}},"markdownRemark":{"id":"fdbd3ef5-5e54-564e-a762-1392ddf40c48","excerpt":"Azure Event Hub SDK Series This post is part 3 of a series of posts on Azure Event Hub SDK for Dot NET. Azure Event Hub SDK Internals - Part 1 (Overviewâ€¦","html":"<h2>Azure Event Hub SDK Series</h2>\n<p>This post is <strong>part 3</strong> of a series of posts on Azure Event Hub SDK for Dot NET.</p>\n<ol>\n<li><a href=\"https://abhikmitra.github.io/blog/event-hub/\">Azure Event Hub SDK Internals - Part 1 (Overview &#x26; Control Flow)</a></li>\n<li><a href=\"https://abhikmitra.github.io/blog/event-hub-2/\">Azure Event Hub SDK Internals - Part 2 (Partition Manager &#x26; Lease Management)</a></li>\n<li><a href=\"https://abhikmitra.github.io/blog/event-hub-3/\">Azure Event Hub SDK Internals - Part 3 (Pumping Data &#x26; AMQP Links)</a></li>\n</ol>\n<p>Do you think there is more that I should cover or something I should fix ? Please raise an <a href=\"https://github.com/abhikmitra/blog/issues\">issue</a> and let me know.</p>\n<hr>\n<p>In this section we will deep dive into the <a href=\"https://github.com/Azure/azure-sdk-for-net/blob/6a73a945124f1e268a86d62a0e2ea5b4bd31c496/sdk/eventhub/Microsoft.Azure.EventHubs.Processor/src/EventHubPartitionPump.cs\">Event Hub Partition Pump</a> in the Event Hub SDK. This is the part that deals with getting the actual data from the Event Hub.</p>\n<h2>Control Flow</h2>\n<p>The control flow starts in the partition Manager. Once the SDK has the proper leases to the partitions, it starts creating or updating the Partition Pumps.</p>\n<ul>\n<li>\n<p>For every partition that is leased by the current host</p>\n<ul>\n<li>It checks and create pumps if necessary.</li>\n</ul>\n</li>\n<li>\n<p>For every partition that is <strong>not</strong> leased by the current host</p>\n<ul>\n<li>We remove the pumps.</li>\n</ul>\n</li>\n</ul>\n<h2>Creating Pumps</h2>\n<p>The partition manager keeps a map of partition id to pumps. . Every turn of the loop, the Partition manager renews/gets new leases and checks if the new pump needs to be created based on the <code class=\"language-text\">partitionId-Pump</code> map. So every PartitionId can have at most 1 pump.</p>\n<h3>Opening the Pump</h3>\n<ul>\n<li>Each partition will have its Partition Pump</li>\n<li>After a pump is created its <code class=\"language-text\">opened</code> asynchronously</li>\n<li>It is in this step that an instance of the <code class=\"language-text\">SimpleEventProcessor</code> is created. Its a singleton, so only the first pump creates the instance, all pumps share the same instance.</li>\n<li>Then the pump calls into <code class=\"language-text\">OpenAsync</code> of <code class=\"language-text\">SimpleEventProcessor</code> and awaits it.</li>\n<li>Once <code class=\"language-text\">SimpleEventProcessor</code> returns we get the checkpoint information from the Lease Blob. The checkpoint is a combination of the Offset and Sequence Number.</li>\n<li>If there is no checkpoint information for that partition, we set the initial offset to -1</li>\n<li>Then we create the Partition Receiver which completes the opening of the pump. We set the pump status to Running.</li>\n</ul>\n<h3>Running the Pump</h3>\n<ul>\n<li>Once the pump is marked as running, the code calls into  <code class=\"language-text\">AmqpPartitionReceiver</code> and sets the receiver which is just a callback into the Pump.</li>\n<li>This triggers the <code class=\"language-text\">PartitionReceiver</code> which starts polling the event hub asynchronously.</li>\n<li>The Partition receiver stops listening when the pump sets the ReceiveHandler to null.</li>\n<li>The receiver bit of the code can be seen <a href=\"https://github.com/Azure/azure-sdk-for-net/blob/3db8feaa87d7e44eb91baf7812edb70fbc8042ad/sdk/eventhub/Microsoft.Azure.EventHubs/src/Amqp/AmqpPartitionReceiver.cs#L276\">here</a>.</li>\n<li>The Partition Receiver runs a while loop till the point it has an active ReceiveHandler.</li>\n<li>\n<ul>\n<li>The partition receiver creates a <code class=\"language-text\">ReceivingAmqpLink</code> that reads the offset from the blob store and creates filters that look like queries - <code class=\"language-text\">amqp.annotation.x-opt-offset &gt; 14832</code>. This is a singleton the AMQP layer will create this once and keep the link alive.</li>\n</ul>\n</li>\n<li>The receiver uses the link to wait for messages for a maximum of 30 seconds after which it restarts the loop and does the health checks on the pump.</li>\n<li>The link to the event hub does not get destroyed and is always on.</li>\n<li>In each iteration it gets data from the event hub, transforms it into <code class=\"language-text\">EventData</code>, and invokes <code class=\"language-text\">ProcessEventsAsync</code> of the simpleEventProcessor.</li>\n<li>The Pump stores the Sequence number, enqueued time, and retrieval time. The epoch is also set</li>\n</ul>\n<p>The overall flow looks like this.</p>\n<div class=\"mermaid\" data-processed=\"true\"><svg id=\"mermaid-1590435048978\" width=\"100%\" xmlns=\"http://www.w3.org/2000/svg\" height=\"100%\" style=\"max-width:1050px;\" viewBox=\"-50 -10 1050 441\"><style>#mermaid-1590435048978 .label{font-family:'trebuchet ms', verdana, arial;font-family:var(--mermaid-font-family);color:#333}#mermaid-1590435048978 .label text{fill:#333}#mermaid-1590435048978 .node rect,#mermaid-1590435048978 .node circle,#mermaid-1590435048978 .node ellipse,#mermaid-1590435048978 .node polygon,#mermaid-1590435048978 .node path{fill:#ECECFF;stroke:#9370db;stroke-width:1px}#mermaid-1590435048978 .node .label{text-align:center}#mermaid-1590435048978 .node.clickable{cursor:pointer}#mermaid-1590435048978 .arrowheadPath{fill:#333}#mermaid-1590435048978 .edgePath .path{stroke:#333;stroke-width:1.5px}#mermaid-1590435048978 .edgeLabel{background-color:#e8e8e8;text-align:center}#mermaid-1590435048978 .cluster rect{fill:#ffffde;stroke:#aa3;stroke-width:1px}#mermaid-1590435048978 .cluster text{fill:#333}#mermaid-1590435048978 div.mermaidTooltip{position:absolute;text-align:center;max-width:200px;padding:2px;font-family:'trebuchet ms', verdana, arial;font-family:var(--mermaid-font-family);font-size:12px;background:#ffffde;border:1px solid #aa3;border-radius:2px;pointer-events:none;z-index:100}#mermaid-1590435048978 .actor{stroke:#ccf;fill:#ECECFF}#mermaid-1590435048978 text.actor{fill:#000;stroke:none}#mermaid-1590435048978 .actor-line{stroke:grey}#mermaid-1590435048978 .messageLine0{stroke-width:1.5;stroke-dasharray:'2 2';stroke:#333}#mermaid-1590435048978 .messageLine1{stroke-width:1.5;stroke-dasharray:'2 2';stroke:#333}#mermaid-1590435048978 #arrowhead{fill:#333}#mermaid-1590435048978 .sequenceNumber{fill:#fff}#mermaid-1590435048978 #sequencenumber{fill:#333}#mermaid-1590435048978 #crosshead path{fill:#333 !important;stroke:#333 !important}#mermaid-1590435048978 .messageText{fill:#333;stroke:none}#mermaid-1590435048978 .labelBox{stroke:#ccf;fill:#ECECFF}#mermaid-1590435048978 .labelText{fill:#000;stroke:none}#mermaid-1590435048978 .loopText{fill:#000;stroke:none}#mermaid-1590435048978 .loopLine{stroke-width:2;stroke-dasharray:'2 2';stroke:#ccf}#mermaid-1590435048978 .note{stroke:#aa3;fill:#fff5ad}#mermaid-1590435048978 .noteText{fill:black;stroke:none;font-family:'trebuchet ms', verdana, arial;font-family:var(--mermaid-font-family);font-size:14px}#mermaid-1590435048978 .activation0{fill:#f4f4f4;stroke:#666}#mermaid-1590435048978 .activation1{fill:#f4f4f4;stroke:#666}#mermaid-1590435048978 .activation2{fill:#f4f4f4;stroke:#666}#mermaid-1590435048978 .mermaid-main-font{font-family:\"trebuchet ms\", verdana, arial;font-family:var(--mermaid-font-family)}#mermaid-1590435048978 .section{stroke:none;opacity:0.2}#mermaid-1590435048978 .section0{fill:rgba(102,102,255,0.49)}#mermaid-1590435048978 .section2{fill:#fff400}#mermaid-1590435048978 .section1,#mermaid-1590435048978 .section3{fill:#fff;opacity:0.2}#mermaid-1590435048978 .sectionTitle0{fill:#333}#mermaid-1590435048978 .sectionTitle1{fill:#333}#mermaid-1590435048978 .sectionTitle2{fill:#333}#mermaid-1590435048978 .sectionTitle3{fill:#333}#mermaid-1590435048978 .sectionTitle{text-anchor:start;font-size:11px;text-height:14px;font-family:'trebuchet ms', verdana, arial;font-family:var(--mermaid-font-family)}#mermaid-1590435048978 .grid .tick{stroke:#d3d3d3;opacity:0.8;shape-rendering:crispEdges}#mermaid-1590435048978 .grid .tick text{font-family:'trebuchet ms', verdana, arial;font-family:var(--mermaid-font-family)}#mermaid-1590435048978 .grid path{stroke-width:0}#mermaid-1590435048978 .today{fill:none;stroke:red;stroke-width:2px}#mermaid-1590435048978 .task{stroke-width:2}#mermaid-1590435048978 .taskText{text-anchor:middle;font-family:'trebuchet ms', verdana, arial;font-family:var(--mermaid-font-family)}#mermaid-1590435048978 .taskText:not([font-size]){font-size:11px}#mermaid-1590435048978 .taskTextOutsideRight{fill:#000;text-anchor:start;font-size:11px;font-family:'trebuchet ms', verdana, arial;font-family:var(--mermaid-font-family)}#mermaid-1590435048978 .taskTextOutsideLeft{fill:#000;text-anchor:end;font-size:11px}#mermaid-1590435048978 .task.clickable{cursor:pointer}#mermaid-1590435048978 .taskText.clickable{cursor:pointer;fill:#003163 !important;font-weight:bold}#mermaid-1590435048978 .taskTextOutsideLeft.clickable{cursor:pointer;fill:#003163 !important;font-weight:bold}#mermaid-1590435048978 .taskTextOutsideRight.clickable{cursor:pointer;fill:#003163 !important;font-weight:bold}#mermaid-1590435048978 .taskText0,#mermaid-1590435048978 .taskText1,#mermaid-1590435048978 .taskText2,#mermaid-1590435048978 .taskText3{fill:#fff}#mermaid-1590435048978 .task0,#mermaid-1590435048978 .task1,#mermaid-1590435048978 .task2,#mermaid-1590435048978 .task3{fill:#8a90dd;stroke:#534fbc}#mermaid-1590435048978 .taskTextOutside0,#mermaid-1590435048978 .taskTextOutside2{fill:#000}#mermaid-1590435048978 .taskTextOutside1,#mermaid-1590435048978 .taskTextOutside3{fill:#000}#mermaid-1590435048978 .active0,#mermaid-1590435048978 .active1,#mermaid-1590435048978 .active2,#mermaid-1590435048978 .active3{fill:#bfc7ff;stroke:#534fbc}#mermaid-1590435048978 .activeText0,#mermaid-1590435048978 .activeText1,#mermaid-1590435048978 .activeText2,#mermaid-1590435048978 .activeText3{fill:#000 !important}#mermaid-1590435048978 .done0,#mermaid-1590435048978 .done1,#mermaid-1590435048978 .done2,#mermaid-1590435048978 .done3{stroke:grey;fill:#d3d3d3;stroke-width:2}#mermaid-1590435048978 .doneText0,#mermaid-1590435048978 .doneText1,#mermaid-1590435048978 .doneText2,#mermaid-1590435048978 .doneText3{fill:#000 !important}#mermaid-1590435048978 .crit0,#mermaid-1590435048978 .crit1,#mermaid-1590435048978 .crit2,#mermaid-1590435048978 .crit3{stroke:#f88;fill:red;stroke-width:2}#mermaid-1590435048978 .activeCrit0,#mermaid-1590435048978 .activeCrit1,#mermaid-1590435048978 .activeCrit2,#mermaid-1590435048978 .activeCrit3{stroke:#f88;fill:#bfc7ff;stroke-width:2}#mermaid-1590435048978 .doneCrit0,#mermaid-1590435048978 .doneCrit1,#mermaid-1590435048978 .doneCrit2,#mermaid-1590435048978 .doneCrit3{stroke:#f88;fill:#d3d3d3;stroke-width:2;cursor:pointer;shape-rendering:crispEdges}#mermaid-1590435048978 .milestone{transform:rotate(45deg) scale(0.8, 0.8)}#mermaid-1590435048978 .milestoneText{font-style:italic}#mermaid-1590435048978 .doneCritText0,#mermaid-1590435048978 .doneCritText1,#mermaid-1590435048978 .doneCritText2,#mermaid-1590435048978 .doneCritText3{fill:#000 !important}#mermaid-1590435048978 .activeCritText0,#mermaid-1590435048978 .activeCritText1,#mermaid-1590435048978 .activeCritText2,#mermaid-1590435048978 .activeCritText3{fill:#000 !important}#mermaid-1590435048978 .titleText{text-anchor:middle;font-size:18px;fill:#000;font-family:'trebuchet ms', verdana, arial;font-family:var(--mermaid-font-family)}#mermaid-1590435048978 g.classGroup text{fill:#9370db;stroke:none;font-family:'trebuchet ms', verdana, arial;font-family:var(--mermaid-font-family);font-size:10px}#mermaid-1590435048978 g.classGroup text .title{font-weight:bolder}#mermaid-1590435048978 g.clickable{cursor:pointer}#mermaid-1590435048978 g.classGroup rect{fill:#ECECFF;stroke:#9370db}#mermaid-1590435048978 g.classGroup line{stroke:#9370db;stroke-width:1}#mermaid-1590435048978 .classLabel .box{stroke:none;stroke-width:0;fill:#ECECFF;opacity:0.5}#mermaid-1590435048978 .classLabel .label{fill:#9370db;font-size:10px}#mermaid-1590435048978 .relation{stroke:#9370db;stroke-width:1;fill:none}#mermaid-1590435048978 .dashed-line{stroke-dasharray:3}#mermaid-1590435048978 #compositionStart{fill:#9370db;stroke:#9370db;stroke-width:1}#mermaid-1590435048978 #compositionEnd{fill:#9370db;stroke:#9370db;stroke-width:1}#mermaid-1590435048978 #aggregationStart{fill:#ECECFF;stroke:#9370db;stroke-width:1}#mermaid-1590435048978 #aggregationEnd{fill:#ECECFF;stroke:#9370db;stroke-width:1}#mermaid-1590435048978 #dependencyStart{fill:#9370db;stroke:#9370db;stroke-width:1}#mermaid-1590435048978 #dependencyEnd{fill:#9370db;stroke:#9370db;stroke-width:1}#mermaid-1590435048978 #extensionStart{fill:#9370db;stroke:#9370db;stroke-width:1}#mermaid-1590435048978 #extensionEnd{fill:#9370db;stroke:#9370db;stroke-width:1}#mermaid-1590435048978 .commit-id,#mermaid-1590435048978 .commit-msg,#mermaid-1590435048978 .branch-label{fill:lightgrey;color:lightgrey;font-family:'trebuchet ms', verdana, arial;font-family:var(--mermaid-font-family)}#mermaid-1590435048978 .pieTitleText{text-anchor:middle;font-size:25px;fill:#000;font-family:'trebuchet ms', verdana, arial;font-family:var(--mermaid-font-family)}#mermaid-1590435048978 .slice{font-family:'trebuchet ms', verdana, arial;font-family:var(--mermaid-font-family)}#mermaid-1590435048978 g.stateGroup text{fill:#9370db;stroke:none;font-size:10px;font-family:'trebuchet ms', verdana, arial;font-family:var(--mermaid-font-family)}#mermaid-1590435048978 g.stateGroup text{fill:#9370db;stroke:none;font-size:10px}#mermaid-1590435048978 g.stateGroup .state-title{font-weight:bolder;fill:#000}#mermaid-1590435048978 g.stateGroup rect{fill:#ECECFF;stroke:#9370db}#mermaid-1590435048978 g.stateGroup line{stroke:#9370db;stroke-width:1}#mermaid-1590435048978 .transition{stroke:#9370db;stroke-width:1;fill:none}#mermaid-1590435048978 .stateGroup .composit{fill:white;border-bottom:1px}#mermaid-1590435048978 .stateGroup .alt-composit{fill:#e0e0e0;border-bottom:1px}#mermaid-1590435048978 .state-note{stroke:#aa3;fill:#fff5ad}#mermaid-1590435048978 .state-note text{fill:black;stroke:none;font-size:10px}#mermaid-1590435048978 .stateLabel .box{stroke:none;stroke-width:0;fill:#ECECFF;opacity:0.5}#mermaid-1590435048978 .stateLabel text{fill:#000;font-size:10px;font-weight:bold;font-family:'trebuchet ms', verdana, arial;font-family:var(--mermaid-font-family)}:root{--mermaid-font-family: '\"trebuchet ms\", verdana, arial';--mermaid-font-family: \"Comic Sans MS\", \"Comic Sans\", cursive}\n\n:root { --mermaid-font-family: \"trebuchet ms\", verdana, arial;}</style><style>#mermaid-1590435048978 {\n    color: rgb(0, 0, 0);\n    font: normal normal 400 normal 16px / normal \"trebuchet ms\", verdana, arial;\n  }</style><g></g><g><line id=\"actor0\" x1=\"75\" y1=\"5\" x2=\"75\" y2=\"430\" class=\"actor-line\" stroke-width=\"0.5px\" stroke=\"#999\"></line><rect x=\"0\" y=\"0\" fill=\"#eaeaea\" stroke=\"#666\" width=\"150\" height=\"65\" rx=\"3\" ry=\"3\" class=\"actor\"></rect><text x=\"75\" y=\"32.5\" dominant-baseline=\"central\" alignment-baseline=\"central\" class=\"actor\" style=\"text-anchor: middle; font-size: 14px;\"><tspan x=\"75\" dy=\"0\">Partition Manager</tspan></text></g><g><line id=\"actor1\" x1=\"275\" y1=\"5\" x2=\"275\" y2=\"430\" class=\"actor-line\" stroke-width=\"0.5px\" stroke=\"#999\"></line><rect x=\"200\" y=\"0\" fill=\"#eaeaea\" stroke=\"#666\" width=\"150\" height=\"65\" rx=\"3\" ry=\"3\" class=\"actor\"></rect><text x=\"275\" y=\"32.5\" dominant-baseline=\"central\" alignment-baseline=\"central\" class=\"actor\" style=\"text-anchor: middle; font-size: 14px;\"><tspan x=\"275\" dy=\"0\">Pump</tspan></text></g><g><line id=\"actor2\" x1=\"475\" y1=\"5\" x2=\"475\" y2=\"430\" class=\"actor-line\" stroke-width=\"0.5px\" stroke=\"#999\"></line><rect x=\"400\" y=\"0\" fill=\"#eaeaea\" stroke=\"#666\" width=\"150\" height=\"65\" rx=\"3\" ry=\"3\" class=\"actor\"></rect><text x=\"475\" y=\"32.5\" dominant-baseline=\"central\" alignment-baseline=\"central\" class=\"actor\" style=\"text-anchor: middle; font-size: 14px;\"><tspan x=\"475\" dy=\"0\">SimpleEventProcessor</tspan></text></g><g><line id=\"actor3\" x1=\"675\" y1=\"5\" x2=\"675\" y2=\"430\" class=\"actor-line\" stroke-width=\"0.5px\" stroke=\"#999\"></line><rect x=\"600\" y=\"0\" fill=\"#eaeaea\" stroke=\"#666\" width=\"150\" height=\"65\" rx=\"3\" ry=\"3\" class=\"actor\"></rect><text x=\"675\" y=\"32.5\" dominant-baseline=\"central\" alignment-baseline=\"central\" class=\"actor\" style=\"text-anchor: middle; font-size: 14px;\"><tspan x=\"675\" dy=\"0\">PartitionReceiver</tspan></text></g><g><line id=\"actor4\" x1=\"875\" y1=\"5\" x2=\"875\" y2=\"430\" class=\"actor-line\" stroke-width=\"0.5px\" stroke=\"#999\"></line><rect x=\"800\" y=\"0\" fill=\"#eaeaea\" stroke=\"#666\" width=\"150\" height=\"65\" rx=\"3\" ry=\"3\" class=\"actor\"></rect><text x=\"875\" y=\"32.5\" dominant-baseline=\"central\" alignment-baseline=\"central\" class=\"actor\" style=\"text-anchor: middle; font-size: 14px;\"><tspan x=\"875\" dy=\"0\">AMQPLink</tspan></text></g><defs><marker id=\"arrowhead\" refX=\"5\" refY=\"2\" markerWidth=\"6\" markerHeight=\"4\" orient=\"auto\"><path d=\"M 0,0 V 4 L6,2 Z\"></path></marker></defs><defs><marker id=\"crosshead\" markerWidth=\"15\" markerHeight=\"8\" orient=\"auto\" refX=\"16\" refY=\"4\"><path fill=\"black\" stroke=\"#000000\" stroke-width=\"1px\" d=\"M 9,2 V 6 L16,4 Z\" style=\"stroke-dasharray: 0, 0;\"></path><path fill=\"none\" stroke=\"#000000\" stroke-width=\"1px\" d=\"M 0,1 L 6,7 M 6,1 L 0,7\" style=\"stroke-dasharray: 0, 0;\"></path></marker></defs><defs><marker id=\"sequencenumber\" refX=\"15\" refY=\"15\" markerWidth=\"60\" markerHeight=\"40\" orient=\"auto\"><circle cx=\"15\" cy=\"15\" r=\"6\"></circle></marker></defs><g><text x=\"175\" y=\"93\" class=\"messageText\" style=\"text-anchor: middle;\">Craetes 1 pump per partition</text><line x1=\"75\" y1=\"100\" x2=\"275\" y2=\"100\" class=\"messageLine0\" stroke-width=\"2\" stroke=\"black\" marker-end=\"url(#arrowhead)\" style=\"fill: none;\"></line></g><g><text x=\"375\" y=\"128\" class=\"messageText\" style=\"text-anchor: middle;\">OpenAsync</text><line x1=\"275\" y1=\"135\" x2=\"475\" y2=\"135\" class=\"messageLine0\" stroke-width=\"2\" stroke=\"black\" marker-end=\"url(#arrowhead)\" style=\"fill: none;\"></line></g><g><text x=\"475\" y=\"163\" class=\"messageText\" style=\"text-anchor: middle;\">Creates a Partition Receiver</text><line x1=\"275\" y1=\"170\" x2=\"675\" y2=\"170\" class=\"messageLine0\" stroke-width=\"2\" stroke=\"black\" marker-end=\"url(#arrowhead)\" style=\"fill: none;\"></line></g><g><text x=\"475\" y=\"198\" class=\"messageText\" style=\"text-anchor: middle;\">SetReceiveHandler</text><line x1=\"275\" y1=\"205\" x2=\"675\" y2=\"205\" class=\"messageLine0\" stroke-width=\"2\" stroke=\"black\" marker-end=\"url(#arrowhead)\" style=\"fill: none;\"></line></g><g><text x=\"775\" y=\"258\" class=\"messageText\" style=\"text-anchor: middle;\">Get Or Create</text><line x1=\"675\" y1=\"265\" x2=\"875\" y2=\"265\" class=\"messageLine0\" stroke-width=\"2\" stroke=\"black\" marker-end=\"url(#arrowhead)\" style=\"fill: none;\"></line></g><g><text x=\"775\" y=\"293\" class=\"messageText\" style=\"text-anchor: middle;\">Receive maximum of 10 messages</text><line x1=\"675\" y1=\"300\" x2=\"875\" y2=\"300\" class=\"messageLine0\" stroke-width=\"2\" stroke=\"black\" marker-end=\"url(#arrowhead)\" style=\"fill: none;\"></line></g><g><text x=\"575\" y=\"328\" class=\"messageText\" style=\"text-anchor: middle;\">ProcessEventsAsync</text><line x1=\"675\" y1=\"335\" x2=\"475\" y2=\"335\" class=\"messageLine0\" stroke-width=\"2\" stroke=\"black\" marker-end=\"url(#arrowhead)\" style=\"fill: none;\"></line></g><g><line x1=\"465\" y1=\"215\" x2=\"885\" y2=\"215\" class=\"loopLine\"></line><line x1=\"885\" y1=\"215\" x2=\"885\" y2=\"345\" class=\"loopLine\"></line><line x1=\"465\" y1=\"345\" x2=\"885\" y2=\"345\" class=\"loopLine\"></line><line x1=\"465\" y1=\"215\" x2=\"465\" y2=\"345\" class=\"loopLine\"></line><polygon points=\"465,215 515,215 515,228 506.6,235 465,235\" class=\"labelBox\"></polygon><text x=\"472.5\" y=\"230\" class=\"labelText\"><tspan x=\"472.5\">loop</tspan></text><text x=\"675\" y=\"230\" class=\"loopText\" style=\"text-anchor: middle;\"><tspan x=\"675\">[ Every 30 seconds, ]</tspan></text></g><g><rect x=\"0\" y=\"365\" fill=\"#eaeaea\" stroke=\"#666\" width=\"150\" height=\"65\" rx=\"3\" ry=\"3\" class=\"actor\"></rect><text x=\"75\" y=\"397.5\" dominant-baseline=\"central\" alignment-baseline=\"central\" class=\"actor\" style=\"text-anchor: middle; font-size: 14px;\"><tspan x=\"75\" dy=\"0\">Partition Manager</tspan></text></g><g><rect x=\"200\" y=\"365\" fill=\"#eaeaea\" stroke=\"#666\" width=\"150\" height=\"65\" rx=\"3\" ry=\"3\" class=\"actor\"></rect><text x=\"275\" y=\"397.5\" dominant-baseline=\"central\" alignment-baseline=\"central\" class=\"actor\" style=\"text-anchor: middle; font-size: 14px;\"><tspan x=\"275\" dy=\"0\">Pump</tspan></text></g><g><rect x=\"400\" y=\"365\" fill=\"#eaeaea\" stroke=\"#666\" width=\"150\" height=\"65\" rx=\"3\" ry=\"3\" class=\"actor\"></rect><text x=\"475\" y=\"397.5\" dominant-baseline=\"central\" alignment-baseline=\"central\" class=\"actor\" style=\"text-anchor: middle; font-size: 14px;\"><tspan x=\"475\" dy=\"0\">SimpleEventProcessor</tspan></text></g><g><rect x=\"600\" y=\"365\" fill=\"#eaeaea\" stroke=\"#666\" width=\"150\" height=\"65\" rx=\"3\" ry=\"3\" class=\"actor\"></rect><text x=\"675\" y=\"397.5\" dominant-baseline=\"central\" alignment-baseline=\"central\" class=\"actor\" style=\"text-anchor: middle; font-size: 14px;\"><tspan x=\"675\" dy=\"0\">PartitionReceiver</tspan></text></g><g><rect x=\"800\" y=\"365\" fill=\"#eaeaea\" stroke=\"#666\" width=\"150\" height=\"65\" rx=\"3\" ry=\"3\" class=\"actor\"></rect><text x=\"875\" y=\"397.5\" dominant-baseline=\"central\" alignment-baseline=\"central\" class=\"actor\" style=\"text-anchor: middle; font-size: 14px;\"><tspan x=\"875\" dy=\"0\">AMQPLink</tspan></text></g></svg></div>\n<p>Though it looks like a poll, in essence what the code is polling is the Link which is persistent across all iterations. The code awaits and asks for the messages from the event hub. Once it gets a batch of messages, it quickly <strong>processes</strong> it by sending it to the <code class=\"language-text\">SimpleEventProcessor</code> and gain comes back to process more. If there are no messages, it simply waits for a minute and continues with the next iteration.</p>","frontmatter":{"title":"Azure Event Hub SDK Internals - Part 3 (Pumping Data & AMQP Link)","date":"May 25, 2020","description":"In this post, we will deep dive into how the SDK gets and pushes data into the EventProcessor"}}},"pageContext":{"slug":"/event-hub-3/","previous":{"fields":{"slug":"/event-hub-2/"},"frontmatter":{"title":"Azure Event Hub SDK Internals - Part 2 (Partition Manager & Lease Management)"}},"next":null}}}