<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta http-equiv="x-ua-compatible" content="ie=edge"/><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/><style id="typography.js">html{font-family:sans-serif;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%}body{margin:0}article,aside,details,figcaption,figure,footer,header,main,menu,nav,section,summary{display:block}audio,canvas,progress,video{display:inline-block}audio:not([controls]){display:none;height:0}progress{vertical-align:baseline}[hidden],template{display:none}a{background-color:transparent;-webkit-text-decoration-skip:objects}a:active,a:hover{outline-width:0}abbr[title]{border-bottom:none;text-decoration:underline;text-decoration:underline dotted}b,strong{font-weight:inherit;font-weight:bolder}dfn{font-style:italic}h1{font-size:2em;margin:.67em 0}mark{background-color:#ff0;color:#000}small{font-size:80%}sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}img{border-style:none}svg:not(:root){overflow:hidden}code,kbd,pre,samp{font-family:monospace,monospace;font-size:1em}figure{margin:1em 40px}hr{box-sizing:content-box;height:0;overflow:visible}button,input,optgroup,select,textarea{font:inherit;margin:0}optgroup{font-weight:700}button,input{overflow:visible}button,select{text-transform:none}[type=reset],[type=submit],button,html [type=button]{-webkit-appearance:button}[type=button]::-moz-focus-inner,[type=reset]::-moz-focus-inner,[type=submit]::-moz-focus-inner,button::-moz-focus-inner{border-style:none;padding:0}[type=button]:-moz-focusring,[type=reset]:-moz-focusring,[type=submit]:-moz-focusring,button:-moz-focusring{outline:1px dotted ButtonText}fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}legend{box-sizing:border-box;color:inherit;display:table;max-width:100%;padding:0;white-space:normal}textarea{overflow:auto}[type=checkbox],[type=radio]{box-sizing:border-box;padding:0}[type=number]::-webkit-inner-spin-button,[type=number]::-webkit-outer-spin-button{height:auto}[type=search]{-webkit-appearance:textfield;outline-offset:-2px}[type=search]::-webkit-search-cancel-button,[type=search]::-webkit-search-decoration{-webkit-appearance:none}::-webkit-input-placeholder{color:inherit;opacity:.54}::-webkit-file-upload-button{-webkit-appearance:button;font:inherit}html{font:100%/1.75 'Merriweather','Georgia',serif;box-sizing:border-box;overflow-y:scroll;}*{box-sizing:inherit;}*:before{box-sizing:inherit;}*:after{box-sizing:inherit;}body{color:hsla(0,0%,0%,0.9);font-family:'Merriweather','Georgia',serif;font-weight:400;word-wrap:break-word;font-kerning:normal;-moz-font-feature-settings:"kern", "liga", "clig", "calt";-ms-font-feature-settings:"kern", "liga", "clig", "calt";-webkit-font-feature-settings:"kern", "liga", "clig", "calt";font-feature-settings:"kern", "liga", "clig", "calt";}img{max-width:100%;margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;}h1{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;color:inherit;font-family:Montserrat,sans-serif;font-weight:900;text-rendering:optimizeLegibility;font-size:2.5rem;line-height:1.1;}h2{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;color:inherit;font-family:'Merriweather','Georgia',serif;font-weight:900;text-rendering:optimizeLegibility;font-size:1.73286rem;line-height:1.1;}h3{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;color:inherit;font-family:'Merriweather','Georgia',serif;font-weight:900;text-rendering:optimizeLegibility;font-size:1.4427rem;line-height:1.1;}h4{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;color:inherit;font-family:'Merriweather','Georgia',serif;font-weight:900;text-rendering:optimizeLegibility;font-size:1rem;line-height:1.1;letter-spacing:0.140625em;text-transform:uppercase;}h5{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;color:inherit;font-family:'Merriweather','Georgia',serif;font-weight:900;text-rendering:optimizeLegibility;font-size:0.83255rem;line-height:1.1;}h6{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;color:inherit;font-family:'Merriweather','Georgia',serif;font-weight:900;text-rendering:optimizeLegibility;font-size:0.75966rem;line-height:1.1;font-style:italic;}hgroup{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;}ul{margin-left:1.75rem;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;list-style-position:outside;list-style-image:none;list-style:disc;}ol{margin-left:1.75rem;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;list-style-position:outside;list-style-image:none;}dl{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;}dd{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;}p{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;}figure{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;}pre{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;font-size:0.85rem;line-height:1.75rem;}table{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;font-size:1rem;line-height:1.75rem;border-collapse:collapse;width:100%;}fieldset{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;}blockquote{margin-left:-1.75rem;margin-right:1.75rem;margin-top:0;padding-bottom:0;padding-left:1.42188rem;padding-right:0;padding-top:0;margin-bottom:1.75rem;font-size:1.20112rem;line-height:1.75rem;color:hsla(0,0%,0%,0.59);font-style:italic;border-left:0.32813rem solid hsla(0,0%,0%,0.9);}form{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;}noscript{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;}iframe{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;}hr{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:calc(1.75rem - 1px);background:hsla(0,0%,0%,0.2);border:none;height:1px;}address{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;}b{font-weight:700;}strong{font-weight:700;}dt{font-weight:700;}th{font-weight:700;}li{margin-bottom:calc(1.75rem / 2);}ol li{padding-left:0;}ul li{padding-left:0;}li > ol{margin-left:1.75rem;margin-bottom:calc(1.75rem / 2);margin-top:calc(1.75rem / 2);}li > ul{margin-left:1.75rem;margin-bottom:calc(1.75rem / 2);margin-top:calc(1.75rem / 2);}blockquote *:last-child{margin-bottom:0;}li *:last-child{margin-bottom:0;}p *:last-child{margin-bottom:0;}li > p{margin-bottom:calc(1.75rem / 2);}code{font-size:0.85rem;line-height:1.75rem;}kbd{font-size:0.85rem;line-height:1.75rem;}samp{font-size:0.85rem;line-height:1.75rem;}abbr{border-bottom:1px dotted hsla(0,0%,0%,0.5);cursor:help;}acronym{border-bottom:1px dotted hsla(0,0%,0%,0.5);cursor:help;}abbr[title]{border-bottom:1px dotted hsla(0,0%,0%,0.5);cursor:help;text-decoration:none;}thead{text-align:left;}td,th{text-align:left;border-bottom:1px solid hsla(0,0%,0%,0.12);font-feature-settings:"tnum";-moz-font-feature-settings:"tnum";-ms-font-feature-settings:"tnum";-webkit-font-feature-settings:"tnum";padding-left:1.16667rem;padding-right:1.16667rem;padding-top:0.875rem;padding-bottom:calc(0.875rem - 1px);}th:first-child,td:first-child{padding-left:0;}th:last-child,td:last-child{padding-right:0;}blockquote > :last-child{margin-bottom:0;}blockquote cite{font-size:1rem;line-height:1.75rem;color:hsla(0,0%,0%,0.9);font-weight:400;}blockquote cite:before{content:"— ";}ul,ol{margin-left:0;}@media only screen and (max-width:480px){ul,ol{margin-left:1.75rem;}blockquote{margin-left:-1.3125rem;margin-right:0;padding-left:0.98438rem;}}h1,h2,h3,h4,h5,h6{margin-top:3.5rem;}a{box-shadow:0 1px 0 0 currentColor;color:#007acc;text-decoration:none;}a:hover,a:active{box-shadow:none;}mark,ins{background:#007acc;color:white;padding:0.10938rem 0.21875rem;text-decoration:none;}a.gatsby-resp-image-link{box-shadow:none;}</style><meta data-react-helmet="true" property="og:description" content="In this part, we look at some of the interesting usages of the Task Parallel Library in DTF "/><link rel="preconnect dns-prefetch" href="https://www.google-analytics.com"/><link rel="alternate" type="application/rss+xml" href="/blog/rss.xml"/><link rel="icon" href="/blog/icons/icon-48x48.png?v=fd6b8e1352aaa808d8b27a40db102c0c"/><link rel="manifest" href="/blog/manifest.webmanifest"/><meta name="theme-color" content="#663399"/><link rel="apple-touch-icon" sizes="48x48" href="/blog/icons/icon-48x48.png?v=fd6b8e1352aaa808d8b27a40db102c0c"/><link rel="apple-touch-icon" sizes="72x72" href="/blog/icons/icon-72x72.png?v=fd6b8e1352aaa808d8b27a40db102c0c"/><link rel="apple-touch-icon" sizes="96x96" href="/blog/icons/icon-96x96.png?v=fd6b8e1352aaa808d8b27a40db102c0c"/><link rel="apple-touch-icon" sizes="144x144" href="/blog/icons/icon-144x144.png?v=fd6b8e1352aaa808d8b27a40db102c0c"/><link rel="apple-touch-icon" sizes="192x192" href="/blog/icons/icon-192x192.png?v=fd6b8e1352aaa808d8b27a40db102c0c"/><link rel="apple-touch-icon" sizes="256x256" href="/blog/icons/icon-256x256.png?v=fd6b8e1352aaa808d8b27a40db102c0c"/><link rel="apple-touch-icon" sizes="384x384" href="/blog/icons/icon-384x384.png?v=fd6b8e1352aaa808d8b27a40db102c0c"/><link rel="apple-touch-icon" sizes="512x512" href="/blog/icons/icon-512x512.png?v=fd6b8e1352aaa808d8b27a40db102c0c"/><title data-react-helmet="true">Durable Task Framework Internals - Part 5 (Interesting usages of TPL in DTF) | Abhik&#x27;s Blog</title><meta data-react-helmet="true" name="description" content="In this part, we look at some of the interesting usages of the Task Parallel Library in DTF "/><meta data-react-helmet="true" property="og:title" content="Durable Task Framework Internals - Part 5 (Interesting usages of TPL in DTF)"/><meta name="generator" content="Gatsby 2.20.12"/><meta data-react-helmet="true" property="og:type" content="website"/><meta data-react-helmet="true" name="twitter:card" content="summary"/><meta data-react-helmet="true" name="twitter:creator" content="complancoder"/><meta data-react-helmet="true" name="twitter:title" content="Durable Task Framework Internals - Part 5 (Interesting usages of TPL in DTF)"/><meta data-react-helmet="true" name="twitter:description" content="In this part, we look at some of the interesting usages of the Task Parallel Library in DTF "/><meta data-react-helmet="true" name="linkedIn" content="https://www.linkedin.com/in/iamabhik/"/><style data-href="/blog/styles.781d48369f427189248e.css">@font-face{font-family:Montserrat;font-style:normal;font-display:swap;font-weight:100;src:local("Montserrat Thin "),local("Montserrat-Thin"),url(/blog/static/montserrat-latin-100-191cc9f50f3b76b9617cb383f19acb7d.woff2) format("woff2"),url(/blog/static/montserrat-latin-100-370318464551d5f25b0f0a78f374faac.woff) format("woff")}@font-face{font-family:Montserrat;font-style:italic;font-display:swap;font-weight:100;src:local("Montserrat Thin italic"),local("Montserrat-Thinitalic"),url(/blog/static/montserrat-latin-100italic-bdeaeb79db315697bd173a55b097dc18.woff2) format("woff2"),url(/blog/static/montserrat-latin-100italic-ecf7d49386e8f265878e735db34a7c4b.woff) format("woff")}@font-face{font-family:Montserrat;font-style:normal;font-display:swap;font-weight:200;src:local("Montserrat Extra Light "),local("Montserrat-Extra Light"),url(/blog/static/montserrat-latin-200-85d5ef9db7f2dc6979172a4a3b2c57cb.woff2) format("woff2"),url(/blog/static/montserrat-latin-200-1fc98e126a3d152549240e6244d7e669.woff) format("woff")}@font-face{font-family:Montserrat;font-style:italic;font-display:swap;font-weight:200;src:local("Montserrat Extra Light italic"),local("Montserrat-Extra Lightitalic"),url(/blog/static/montserrat-latin-200italic-49095760a498d024fe1a85a078850df9.woff2) format("woff2"),url(/blog/static/montserrat-latin-200italic-fe46cf8b9462c820457d3bf537e4057f.woff) format("woff")}@font-face{font-family:Montserrat;font-style:normal;font-display:swap;font-weight:300;src:local("Montserrat Light "),local("Montserrat-Light"),url(/blog/static/montserrat-latin-300-7c3daf12b706645b5d3710f863a4da04.woff2) format("woff2"),url(/blog/static/montserrat-latin-300-8dc95fab9cf98d02ca8d76e97d3dff60.woff) format("woff")}@font-face{font-family:Montserrat;font-style:italic;font-display:swap;font-weight:300;src:local("Montserrat Light italic"),local("Montserrat-Lightitalic"),url(/blog/static/montserrat-latin-300italic-f20b178ca2024a5eac8e42e6649db86c.woff2) format("woff2"),url(/blog/static/montserrat-latin-300italic-3fe16939288856e8e828fa2661bf2354.woff) format("woff")}@font-face{font-family:Montserrat;font-style:normal;font-display:swap;font-weight:400;src:local("Montserrat Regular "),local("Montserrat-Regular"),url(/blog/static/montserrat-latin-400-bc3aa95dca08f5fee5291e34959c27bc.woff2) format("woff2"),url(/blog/static/montserrat-latin-400-8102c4838f9e3d08dad644290a9cb701.woff) format("woff")}@font-face{font-family:Montserrat;font-style:italic;font-display:swap;font-weight:400;src:local("Montserrat Regular italic"),local("Montserrat-Regularitalic"),url(/blog/static/montserrat-latin-400italic-5cad650422a7184467af5a4d17b264c4.woff2) format("woff2"),url(/blog/static/montserrat-latin-400italic-d191f22af3bb50902b99ac577f81a322.woff) format("woff")}@font-face{font-family:Montserrat;font-style:normal;font-display:swap;font-weight:500;src:local("Montserrat Medium "),local("Montserrat-Medium"),url(/blog/static/montserrat-latin-500-92d16e458625f4d2c8940f6bdca0ff09.woff2) format("woff2"),url(/blog/static/montserrat-latin-500-8b763220218ffc11c57c84ddb80e7b26.woff) format("woff")}@font-face{font-family:Montserrat;font-style:italic;font-display:swap;font-weight:500;src:local("Montserrat Medium italic"),local("Montserrat-Mediumitalic"),url(/blog/static/montserrat-latin-500italic-47bfcca6b69d6a9acca7a8bff17193e2.woff2) format("woff2"),url(/blog/static/montserrat-latin-500italic-72c01f753c3940c0b9cb6bf2389caddf.woff) format("woff")}@font-face{font-family:Montserrat;font-style:normal;font-display:swap;font-weight:600;src:local("Montserrat SemiBold "),local("Montserrat-SemiBold"),url(/blog/static/montserrat-latin-600-6fb1b5623e528e27c18658fecf5ee0ee.woff2) format("woff2"),url(/blog/static/montserrat-latin-600-7c839d15a6f54e7025ba8c0c4b333e8f.woff) format("woff")}@font-face{font-family:Montserrat;font-style:italic;font-display:swap;font-weight:600;src:local("Montserrat SemiBold italic"),local("Montserrat-SemiBolditalic"),url(/blog/static/montserrat-latin-600italic-60789af1c9338ed1a9546722ec54b4f7.woff2) format("woff2"),url(/blog/static/montserrat-latin-600italic-f3d4de8d0afb19e777c79032ce828e3d.woff) format("woff")}@font-face{font-family:Montserrat;font-style:normal;font-display:swap;font-weight:700;src:local("Montserrat Bold "),local("Montserrat-Bold"),url(/blog/static/montserrat-latin-700-39d93cf678c740f9f6b2b1cfde34bee3.woff2) format("woff2"),url(/blog/static/montserrat-latin-700-80f10bd382f0df1cd650fec59f3c9394.woff) format("woff")}@font-face{font-family:Montserrat;font-style:italic;font-display:swap;font-weight:700;src:local("Montserrat Bold italic"),local("Montserrat-Bolditalic"),url(/blog/static/montserrat-latin-700italic-ba136d97b14e82284dd595e257f11c47.woff2) format("woff2"),url(/blog/static/montserrat-latin-700italic-8c98142b425630821139c24bd1698700.woff) format("woff")}@font-face{font-family:Montserrat;font-style:normal;font-display:swap;font-weight:800;src:local("Montserrat ExtraBold "),local("Montserrat-ExtraBold"),url(/blog/static/montserrat-latin-800-b7018be9ed6cd94da8b6675b3a468c3b.woff2) format("woff2"),url(/blog/static/montserrat-latin-800-9a9befcf50d64f9d2d19d8b1d1984add.woff) format("woff")}@font-face{font-family:Montserrat;font-style:italic;font-display:swap;font-weight:800;src:local("Montserrat ExtraBold italic"),local("Montserrat-ExtraBolditalic"),url(/blog/static/montserrat-latin-800italic-540ffdd223d1a9ad3d4e678e1a23372e.woff2) format("woff2"),url(/blog/static/montserrat-latin-800italic-897086f99f4e1f45e6b1e9368527d0bc.woff) format("woff")}@font-face{font-family:Montserrat;font-style:normal;font-display:swap;font-weight:900;src:local("Montserrat Black "),local("Montserrat-Black"),url(/blog/static/montserrat-latin-900-58cd789700850375b834e8b6776002eb.woff2) format("woff2"),url(/blog/static/montserrat-latin-900-26d42c9428780e545a540bbb50c84bce.woff) format("woff")}@font-face{font-family:Montserrat;font-style:italic;font-display:swap;font-weight:900;src:local("Montserrat Black italic"),local("Montserrat-Blackitalic"),url(/blog/static/montserrat-latin-900italic-451157bc8861fe54f523b3669a3def71.woff2) format("woff2"),url(/blog/static/montserrat-latin-900italic-a8ec4957e1c24f5793305763ad9845b3.woff) format("woff")}@font-face{font-family:Merriweather;font-style:normal;font-display:swap;font-weight:300;src:local("Merriweather Light "),local("Merriweather-Light"),url(/blog/static/merriweather-latin-300-b1158cfcd4aacb9d8fb61625e37af46a.woff2) format("woff2"),url(/blog/static/merriweather-latin-300-cc7de05e166e90320d7d896e0f72a19d.woff) format("woff")}@font-face{font-family:Merriweather;font-style:italic;font-display:swap;font-weight:300;src:local("Merriweather Light italic"),local("Merriweather-Lightitalic"),url(/blog/static/merriweather-latin-300italic-8fe52a48089d6ebe46db0b8e7cc66263.woff2) format("woff2"),url(/blog/static/merriweather-latin-300italic-e1331f5397c2a673f9d3765138debdb5.woff) format("woff")}@font-face{font-family:Merriweather;font-style:normal;font-display:swap;font-weight:400;src:local("Merriweather Regular "),local("Merriweather-Regular"),url(/blog/static/merriweather-latin-400-8276fdb72ae8f4714d4e6eba704cc39f.woff2) format("woff2"),url(/blog/static/merriweather-latin-400-69f09800f4f6479d06e44eba837df872.woff) format("woff")}@font-face{font-family:Merriweather;font-style:italic;font-display:swap;font-weight:400;src:local("Merriweather Regular italic"),local("Merriweather-Regularitalic"),url(/blog/static/merriweather-latin-400italic-3a9be9ea9f7aa4af6de7307df21d9fc0.woff2) format("woff2"),url(/blog/static/merriweather-latin-400italic-d76079ed7541a433a54f79316de086e9.woff) format("woff")}@font-face{font-family:Merriweather;font-style:normal;font-display:swap;font-weight:700;src:local("Merriweather Bold "),local("Merriweather-Bold"),url(/blog/static/merriweather-latin-700-fa534be7ffa380e39a7f6e03bf9a5e03.woff2) format("woff2"),url(/blog/static/merriweather-latin-700-ba56ea84b8084b7ff9677f50d3cd81bd.woff) format("woff")}@font-face{font-family:Merriweather;font-style:italic;font-display:swap;font-weight:700;src:local("Merriweather Bold italic"),local("Merriweather-Bolditalic"),url(/blog/static/merriweather-latin-700italic-1ef5edaaa20ae53ea50399884c5e48c6.woff2) format("woff2"),url(/blog/static/merriweather-latin-700italic-534bc9e7ce93c73d73426e46acd78092.woff) format("woff")}@font-face{font-family:Merriweather;font-style:normal;font-display:swap;font-weight:900;src:local("Merriweather Black "),local("Merriweather-Black"),url(/blog/static/merriweather-latin-900-7528fb70e8a4a82c7305e72ff43ac25f.woff2) format("woff2"),url(/blog/static/merriweather-latin-900-3799b6e2f5ed3fcccf9d7a708d7419fa.woff) format("woff")}@font-face{font-family:Merriweather;font-style:italic;font-display:swap;font-weight:900;src:local("Merriweather Black italic"),local("Merriweather-Blackitalic"),url(/blog/static/merriweather-latin-900italic-e1b4d2aaa78e12ad84aaf8a56321e4c2.woff2) format("woff2"),url(/blog/static/merriweather-latin-900italic-2ae22f731b3424e8dbb4b37f7ca6e708.woff) format("woff")}code[class*=language-],pre[class*=language-]{color:#ccc;background:none;font-family:Consolas,Monaco,Andale Mono,Ubuntu Mono,monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-ms-hyphens:none;hyphens:none}pre[class*=language-]{padding:1em;margin:.5em 0;overflow:auto}:not(pre)>code[class*=language-],pre[class*=language-]{background:#2d2d2d}:not(pre)>code[class*=language-]{padding:.1em;border-radius:.3em;white-space:normal}.token.block-comment,.token.cdata,.token.comment,.token.doctype,.token.prolog{color:#999}.token.punctuation{color:#ccc}.token.attr-name,.token.deleted,.token.namespace,.token.tag{color:#e2777a}.token.function-name{color:#6196cc}.token.boolean,.token.function,.token.number{color:#f08d49}.token.class-name,.token.constant,.token.property,.token.symbol{color:#f8c555}.token.atrule,.token.builtin,.token.important,.token.keyword,.token.selector{color:#cc99cd}.token.attr-value,.token.char,.token.regex,.token.string,.token.variable{color:#7ec699}.token.entity,.token.operator,.token.url{color:#67cdcc}.token.bold,.token.important{font-weight:700}.token.italic{font-style:italic}.token.entity{cursor:help}.token.inserted{color:green}</style><link as="script" rel="preload" href="/blog/component---src-templates-blog-post-js-603e003d35c7316a3610.js"/><link as="script" rel="preload" href="/blog/69ca9dfa785447e3d8b116b383997bcdc8df623a-e846e6165360833579bc.js"/><link as="script" rel="preload" href="/blog/commons-257f2cc47edbd46eb2b4.js"/><link as="script" rel="preload" href="/blog/app-2cb18ef149383859188d.js"/><link as="script" rel="preload" href="/blog/framework-624f79e66261973aaa49.js"/><link as="script" rel="preload" href="/blog/styles-55b12e3f12e70f5e0cab.js"/><link as="script" rel="preload" href="/blog/webpack-runtime-c593f8b747f91b29dbc3.js"/><link as="fetch" rel="preload" href="/blog/page-data\durable-task-5\page-data.json" crossorigin="anonymous"/><link as="fetch" rel="preload" href="/blog/page-data\app-data.json" crossorigin="anonymous"/></head><body><div id="___gatsby"><div style="outline:none" tabindex="-1" id="gatsby-focus-wrapper"><div style="margin-left:auto;margin-right:auto;max-width:42rem;padding:2.625rem 1.3125rem"><header><h3 style="font-family:Montserrat, sans-serif;margin-top:0"><a style="box-shadow:none;color:inherit" href="/blog/">Abhik&#x27;s Blog</a></h3></header><main><article><header><h1 style="margin-top:1.75rem;margin-bottom:0">Durable Task Framework Internals - Part 5 (Interesting usages of TPL in DTF)</h1><p style="font-size:0.83255rem;line-height:1.75rem;display:block;margin-bottom:1.75rem">April 27, 2020</p></header><section><h3>Durable Task Framework Series</h3>
<p>This post is <strong>part 5</strong> of a series of posts on DTF.</p>
<ol>
<li><a href="https://abhikmitra.github.io/blog/durable-task/">Durable Task Framework Internals - Part 1 (Dataflow and Reliability)</a></li>
<li><a href="https://abhikmitra.github.io/blog/durable-task-2/">Durable Task Framework Internals - Part 2 (The curious case of Orchestrations)</a></li>
<li><a href="https://abhikmitra.github.io/blog/durable-task-3/">Durable Task Framework Internals - Part 3 (Tracker Queue, Instance History, and JumpStart)</a></li>
<li><a href="https://abhikmitra.github.io/blog/durable-task-4/">Durable Task Framework Internals - Part 4 (Terminated Orchestrations &#x26; Middlewares)</a></li>
<li><a href="https://abhikmitra.github.io/blog/durable-task-5/">Durable Task Framework Internals - Part 5 (Interesting usages of TPL in DTF)</a></li>
<li><a href="https://abhikmitra.github.io/blog/durable-task-5/">Durable Task Framework Internals - Part 6 (Orchestration Execution Flow)</a></li>
</ol>
<p>Do you think there is more that I should cover or something I should fix? Please raise an <a href="https://github.com/abhikmitra/blog/issues">issue</a> and let me know.</p>
<hr>
<p>In this post, we are going to cover all the interesting Dot Net’s Task Parallel Library concepts that I found here. Some of them might not be advanced, but I have put them as I have not used these often in my regular code.</p>
<h3>Thread Static</h3>
<p>ThreadStatic is an attribute that marks a variable as static. You can read more about it <a href="https://www.c-sharpcorner.com/article/overview-of-threadstatic-attribute-in-c-sharp/">here</a>. ThreadStatic is pretty simple to grasp. The <code class="language-text">OrchestrationContext</code> has a <em>ThreadStatic</em> variable to check any time during your orchestration to see if you are on the correct thread. Now, this usually is not required, as Orchestrations should not have async operations. But if Orchestration is executing a piece of code that you have no control over and you want to check that when control comes back to your code for illegal task continuations, this would be an excellent way to check. Based on the PR <a href="https://github.com/Azure/durabletask/pull/171#discussion_r183195689">here</a>, this is precisely how it is used by the Azure Durable Functions team.</p>
<h3>Synchronization Context</h3>
<p>Synchronization Context is a little difficult to grasp. Here are the articles you should read with to understand SynchronizationContext.</p>
<ul>
<li><a href="https://hamidmosalla.com/2018/06/24/what-is-synchronizationcontext/">What is SynchronizationContext ?</a></li>
<li><a href="https://devblogs.microsoft.com/pfxteam/await-synchronizationcontext-and-console-apps/">SynchronizationContext and Console Apps</a></li>
</ul>
<div class="gatsby-highlight" data-language="csharp"><pre style="counter-reset: linenumber NaN" class="language-csharp line-numbers"><code class="language-csharp">Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">"Thread {0}"</span><span class="token punctuation">,</span> Thread<span class="token punctuation">.</span>CurrentThread<span class="token punctuation">.</span>ManagedThreadId<span class="token punctuation">)</span>
<span class="token keyword">await</span> task1
Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">"Thread {0}"</span><span class="token punctuation">,</span> Thread<span class="token punctuation">.</span>CurrentThread<span class="token punctuation">.</span>ManagedThreadId<span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>
<p>In the above code, there is no guarantee that pre and post-task, both threads are going to be the same. What await is going to try and do is to bring back the back to control to the same SynchronizationContext. If it can find a SynchronizationContext, it will use the thread, if the <code class="language-text">SynchronizationContext.Current</code> is null, it will choose any thread of the thread pool and continue on it.
Now there are cases where SynchronizationContext is not null, like in a WPF app or other UI facing apps. In case of console apps, the starting SynchronizationContext is  null. Durable Task Framework runs the orchestration on the same thread, irrespective of whether you are running the hub in a console app or in some other way. So to achieve this, in the <code class="language-text">TaskOrchestrationExecutor</code> just before Orchestration is executed, DTF sets the SynchronizationContext and unsets it after the Orchestraton is complete.
Now when you do an <code class="language-text">await</code> inside the orchestration, it might still span a thread to do an async operation, but when the execution of the async operation is completed, it will always come back to the starting thread using the SynchronizationContext.</p>
<h3>TaskCompletionSource</h3>
<p>These 2 articles do a pretty good job of explaining <code class="language-text">TaskCompletionSource</code>.</p>
<ul>
<li><a href="https://www.pluralsight.com/guides/task-taskcompletion-source-csharp">Task vs. TaskCompletionSource</a></li>
<li><a href="https://stackoverflow.com/questions/15316613/when-should-taskcompletionsourcet-be-used">When should TaskCompletionSource be used ?</a></li>
</ul>
<p>So now, you know that TaskCompletion sources is used to convert an event-driven code to a more promise based/awaitable pattern.
Now in DTF, we have discussed that Orchestrations get executed multiple times. Let’s assume that an orchestration as one below</p>
<div class="gatsby-highlight" data-language="csharp"><pre style="counter-reset: linenumber NaN" class="language-csharp line-numbers"><code class="language-csharp"><span class="token keyword">public</span> <span class="token keyword">async</span> Task<span class="token operator">&lt;</span><span class="token keyword">bool</span><span class="token operator">></span> <span class="token function">RunTask</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">var</span> task1 <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">ScheduleWithRetry</span><span class="token punctuation">&lt;</span><span class="token keyword">bool</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token keyword">typeof</span><span class="token punctuation">(</span>TestActivity1<span class="token punctuation">)</span><span class="token punctuation">,</span> options<span class="token punctuation">,</span> <span class="token string">"Test Input1"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">var</span> str <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token keyword">string</span><span class="token punctuation">(</span><span class="token string">'x'</span><span class="token punctuation">,</span> <span class="token number">500</span> <span class="token operator">*</span> <span class="token number">1024</span> <span class="token operator">*</span> <span class="token number">1024</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">await</span> Task<span class="token punctuation">.</span><span class="token function">Delay</span><span class="token punctuation">(</span><span class="token number">90000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span>str<span class="token punctuation">.</span><span class="token function">Substring</span><span class="token punctuation">(</span>str<span class="token punctuation">.</span>Length <span class="token operator">-</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    str <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token keyword">true</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>And from somewhere else in the code.</p>
<div class="gatsby-highlight" data-language="csharp"><pre style="counter-reset: linenumber NaN" class="language-csharp line-numbers"><code class="language-csharp"><span class="token keyword">public</span> <span class="token class-name">Task</span> <span class="token function">ExecuteOrchestrationAsync</span><span class="token punctuation">(</span><span class="token keyword">string</span> runTimeState<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token function">RunTask</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> Task<span class="token punctuation">.</span><span class="token function">FromResult</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>So, we are invoking RunTask and not waiting for it to complete. As a result, now we are stuck with 500 MB of data, which will be in memory for 90 seconds. Considering that orchestrations can run days. What would you expect for the below piece of code?</p>
<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">public async Task&lt;bool&gt; RunTask()
{
    var task1 = context.ScheduleWithRetry&lt;bool&gt;(typeof(TestActivity1), options, &quot;Test Input1&quot;);
    var str = new string(&#39;x&#39;, 500 * 1024 * 1024);
    await task1;
    Console.WriteLine(str.Substring(str.Length - 10));
    str = null;
    return true;
}</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>Tasks typically take much more than 90 seconds. And considering the orchestration would be invoked at least 2 times, we are looking at 1 GB of data per task. And if you remember Part 2, Orchestration gets executed multiple times, and it is perfectly normal for orchestration to Execute <code class="language-text">await task</code> and never come back. So what happens is that <code class="language-text">ScheduleWithRetry</code> gives back a TaskCompletionSource. </p>
<p>And whenever the framework detects that </p>
<ul>
<li>There is no reference to TaskCompletionSource, so it cannot be set as completed.</li>
<li>The async call itself is not awaited</li>
</ul>
<p>It garbage collects the memory.</p>
<p>So hence, you will not see the memory leak that you would typically expect with async operations as the framework is smart enough to distinguish between the tasks that may complete and tasks that will never complete.
This is not generally a recommended pattern, as per the <a href="https://devblogs.microsoft.com/pfxteam/dont-forget-to-complete-your-tasks/">experts</a>.</p></section><hr style="margin-bottom:1.75rem"/><footer><div style="display:flex;margin-bottom:4.375rem"><div class=" gatsby-image-wrapper" style="position:relative;overflow:hidden;display:inline-block;width:50px;height:50px;margin-right:0.875rem;margin-bottom:0;min-width:50px;border-radius:100%"><img aria-hidden="true" src="data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAUABQDASIAAhEBAxEB/8QAFgABAQEAAAAAAAAAAAAAAAAAAwAC/8QAFQEBAQAAAAAAAAAAAAAAAAAAAgP/2gAMAwEAAhADEAAAARJ1hYp4LCVeK1I//8QAGxAAAgIDAQAAAAAAAAAAAAAAAQMAAhESITL/2gAIAQEAAQUCfDvlXm1NytZYQkrluHJqFnn/xAAZEQADAAMAAAAAAAAAAAAAAAAAARECEDH/2gAIAQMBAT8BqFIZd1//xAAZEQACAwEAAAAAAAAAAAAAAAAAAQIQETH/2gAIAQIBAT8BSHukeV//xAAaEAADAAMBAAAAAAAAAAAAAAAAARECIXFB/9oACAEBAAY/AsEPKmi2JDr0RbQulXo+n//EABsQAQADAQADAAAAAAAAAAAAAAEAETEhQYHB/9oACAEBAAE/IUWxewnY3JVVmrin9DObVUQ0lg/a7mE+Ubk7qJ7E/9oADAMBAAIAAwAAABBkH4P/xAAXEQEBAQEAAAAAAAAAAAAAAAABEQAQ/9oACAEDAQE/EGjc0Hp//8QAGBEBAAMBAAAAAAAAAAAAAAAAAQAQETH/2gAIAQIBAT8QTDISjJwr/8QAHBABAAMBAAMBAAAAAAAAAAAAAQARITFhcZFR/9oACAEBAAE/EMcN2Lf0irYHBlHHxyX/AEPXwR+7O1ar4fIpMxhScITZ1HD6fkaBjP3rBOiBeopkFUn/2Q==" alt="Abhik Mitra" style="position:absolute;top:0;left:0;width:100%;height:100%;object-fit:cover;object-position:center;opacity:1;transition-delay:500ms;border-radius:50%"/><noscript><picture><source srcset="/blog/static/f693cb87ce63b88a182a754d2cdcea1a/99438/profile-pic.jpg 1x,
/blog/static/f693cb87ce63b88a182a754d2cdcea1a/aba1d/profile-pic.jpg 1.5x,
/blog/static/f693cb87ce63b88a182a754d2cdcea1a/b315d/profile-pic.jpg 2x" /><img loading="lazy" width="50" height="50" srcset="/blog/static/f693cb87ce63b88a182a754d2cdcea1a/99438/profile-pic.jpg 1x,
/blog/static/f693cb87ce63b88a182a754d2cdcea1a/aba1d/profile-pic.jpg 1.5x,
/blog/static/f693cb87ce63b88a182a754d2cdcea1a/b315d/profile-pic.jpg 2x" src="/blog/static/f693cb87ce63b88a182a754d2cdcea1a/99438/profile-pic.jpg" alt="Abhik Mitra" style="position:absolute;top:0;left:0;opacity:1;width:100%;height:100%;object-fit:cover;object-position:center"/></picture></noscript></div><p>Written by <strong>Abhik Mitra</strong> <!-- -->who lives in Bangalore and loves building and learning new things.<!-- --> <a href="https://twitter.com/complancoder">You should follow him on Twitter</a></p></div></footer></article><nav><ul style="display:flex;flex-wrap:wrap;justify-content:space-between;list-style:none;padding:0"><li><a rel="prev" href="/blog/durable-task-4/">← <!-- -->Durable Task Framework Internals - Part 4 (Terminated Orchestrations &amp; Middlewares)</a></li><li><a rel="next" href="/blog/durable-task-6/">Durable Task Framework Internals - Part 6 (Orchestration Execution Flow)<!-- --> →</a></li></ul></nav></main><footer><hr/></footer></div></div><div id="gatsby-announcer" style="position:absolute;top:0;width:1px;height:1px;padding:0;overflow:hidden;clip:rect(0, 0, 0, 0);white-space:nowrap;border:0" aria-live="assertive" aria-atomic="true"></div></div><script>
  
  
  if(true) {
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
  }
  if (typeof ga === "function") {
    ga('create', 'UA-164581916-1', 'auto', {});
      
      
      
      
      
      }</script><script id="gatsby-script-loader">/*<![CDATA[*/window.pagePath="/durable-task-5/";/*]]>*/</script><script id="gatsby-chunk-mapping">/*<![CDATA[*/window.___chunkMapping={"app":["/app-2cb18ef149383859188d.js"],"component---src-templates-blog-post-js":["/component---src-templates-blog-post-js-603e003d35c7316a3610.js"],"component---src-pages-404-js":["/component---src-pages-404-js-c720a9d310a7ee983590.js"],"component---src-pages-index-js":["/component---src-pages-index-js-605690f47d5f32fd4fd2.js"]};/*]]>*/</script><script src="/blog/webpack-runtime-c593f8b747f91b29dbc3.js" async=""></script><script src="/blog/styles-55b12e3f12e70f5e0cab.js" async=""></script><script src="/blog/framework-624f79e66261973aaa49.js" async=""></script><script src="/blog/app-2cb18ef149383859188d.js" async=""></script><script src="/blog/commons-257f2cc47edbd46eb2b4.js" async=""></script><script src="/blog/69ca9dfa785447e3d8b116b383997bcdc8df623a-e846e6165360833579bc.js" async=""></script><script src="/blog/component---src-templates-blog-post-js-603e003d35c7316a3610.js" async=""></script></body></html>